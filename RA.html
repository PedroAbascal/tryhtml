<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruta AR Biología - CCG</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/troika-three-text@0.47.2/dist/troika-three-text.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #instrucciones {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      font-family: sans-serif;
      padding: 10px 20px;
      border-radius: 10px;
      z-index: 1000;
      pointer-events: none;
    }
    #menu {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
      pointer-events: auto;
    }
    #panel {
      position: fixed;
      top: 60px;
      right: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-family: sans-serif;
      display: none;
      width: 220px;
      z-index: 1000;
      pointer-events: auto;
    }
    #panel button {
      background: #00b894;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 8px;
    }
    #mensaje {
      position: fixed;
      bottom: 50%;
      left: 50%;
      transform: translate(-50%, 50%);
      background: rgba(0,255,128,0.85);
      color: black;
      padding: 10px 20px;
      border-radius: 12px;
      font-family: sans-serif;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="instrucciones">📸 Apunta la cámara al QR y toca la imagen para explorar</div>
  <div id="menu">📊 Progreso</div>
  <div id="panel">
    <h4>Tu progreso</h4>
    <p id="progreso">Descubiertos: 0 de 4</p>
    <p id="tiempo">Tiempo: 0 s</p>
    <button id="reset">Reiniciar</button>
  </div>
  <div id="mensaje">🧬</div>

  <a-scene embedded vr-mode-ui="enabled: false"
           arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
           style="z-index:0;">

    <!-- === ESTACIÓN 1: E. COLI === -->
    <a-marker type="pattern"
      url="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/ecoli-qr.patt"
      id="ecoli-marker">

      <a-entity light="type: ambient; intensity: 2"></a-entity>

      <a-plane id="img-ecoli" class="interactivo"
        src="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/ecoli.png"
        height="2" width="2"
        position="0 0.5 0"
        rotation="-90 0 0"
        material="shader: flat; transparent: true; side: double;">
      </a-plane>

      <a-entity id="orbitas-ecoli" rotation="-90 0 0" visible="false">
        <a-entity troika-text="value: 🧫 Escherichia coli; color: #00ffaa; align: center; fontSize: 0.25;" position="0 1.5 0"></a-entity>
        <a-entity troika-text="value: 🌡 Nivel de peligrosidad: 6/10; color: #ffaa00; align: center; fontSize: 0.25;" position="-1.8 0.8 0"></a-entity>
        <a-entity troika-text="value: 🩺 Enfermedades:\n- Gastroenteritis\n- Infección urinaria; color: #ff5555; align: center; fontSize: 0.23;" position="0 -0.5 1.8"></a-entity>
        <a-entity troika-text="value: 🧼 Prevención:\n- Lavado de manos\n- Cocción adecuada; color: #00ddff; align: center; fontSize: 0.23;" position="1.8 0.8 0"></a-entity>
      </a-entity>
    </a-marker>

    <!-- === ESTACIÓN 2: DIFTERIA === -->
    <a-marker type="pattern"
      url="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/pattern-qrdifteria.patt"
      id="difteria-marker">

      <a-entity light="type: ambient; intensity: 2"></a-entity>

      <a-plane id="img-difteria" class="interactivo"
        src="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/difteria.png"
        height="2" width="2"
        position="0 0.5 0"
        rotation="-90 0 0"
        material="shader: flat; transparent: true; side: double;">
      </a-plane>

      <a-entity id="orbitas-difteria" rotation="-90 0 0" visible="false">
        <a-entity troika-text="value: 🧫 Corynebacterium diphtheriae; color: #00ffaa; align: center; fontSize: 0.25;" position="0 1.5 0"></a-entity>
        <a-entity troika-text="value: 🌡 Nivel de peligrosidad: 8/10; color: #ffaa00; align: center; fontSize: 0.25;" position="-1.8 0.8 0"></a-entity>
        <a-entity troika-text="value: 🩺 Enfermedades:\n- Difteria respiratoria\n- Difteria cutánea; color: #ff5555; align: center; fontSize: 0.23;" position="0 -0.5 1.8"></a-entity>
        <a-entity troika-text="value: 🧼 Prevención:\n- Vacunación DTP\n- Higiene personal; color: #00ddff; align: center; fontSize: 0.23;" position="1.8 0.8 0"></a-entity>
      </a-entity>
    </a-marker>

    <a-entity camera look-controls>
      <a-cursor fuse="false" raycaster="objects: .interactivo"
                material="color: #00ffaa; shader: flat; opacity:0.25;"
                geometry="primitive: ring; radiusInner: 0.0; radiusOuter: 0.0085">
      </a-cursor>
    </a-entity>
  </a-scene>

  <script>
    // --- Sistema de progreso local ---
    const totalMarcas = 4;
    const progreso = JSON.parse(localStorage.getItem("progresoAR")) || { inicio: null, encontrados: [] };
    const panel = document.getElementById("panel");
    const progresoText = document.getElementById("progreso");
    const tiempoText = document.getElementById("tiempo");
    const mensaje = document.getElementById("mensaje");

    if (!progreso.inicio) progreso.inicio = Date.now();

    function actualizarPanel() {
      const segundos = Math.floor((Date.now() - progreso.inicio) / 1000);
      progresoText.textContent = `Descubiertos: ${progreso.encontrados.length} de ${totalMarcas}`;
      tiempoText.textContent = `Tiempo: ${segundos} s`;
    }

    function guardarProgreso() {
      localStorage.setItem("progresoAR", JSON.stringify(progreso));
      actualizarPanel();
    }

    function mostrarMensaje(texto) {
      mensaje.textContent = texto;
      mensaje.style.display = "block";
      setTimeout(() => mensaje.style.display = "none", 2000);
    }

    // --- Componente orbitar actualizado ---
    AFRAME.registerComponent("orbitar", {
      schema: { velocidad: {type: "number", default: 0.5 }, radio: {type: "number", default: 2.2 } },
      init: function () {
        this.angulo = 0;
        this.textos = Array.from(this.el.children);
      },
      tick: function (t, dt) {
        this.angulo += (this.data.velocidad * dt) / 5000;
        const r = this.data.radio;
        this.textos.forEach((txt, i) => {
          const offset = (i / this.textos.length) * Math.PI * 2;
          const x = Math.cos(this.angulo + offset) * r;
          const y = Math.sin(this.angulo + offset) * 1.0;
          const escala = 0.8 + 0.4 * (0.5 + Math.sin(this.angulo + offset));
          txt.setAttribute("position", { x: x, y: y + 0.5, z: 0 });
          txt.setAttribute("scale", { x: escala, y: escala, z: escala });
        });
      }
    });

    // --- Interacción de cada estación ---
    function activarInteraccion(idImg, idOrbitas, idMarker, nombre) {
	  const img = document.getElementById(idImg);
	  const orbitas = document.getElementById(idOrbitas);
	  const marker = document.getElementById(idMarker);

	  img.addEventListener("click", () => {
		const visible = orbitas.getAttribute("visible");
		orbitas.setAttribute("visible", !visible);
		if (!visible && navigator.vibrate) navigator.vibrate(30);
		if (!visible) orbitas.setAttribute("orbitar", "velocidad:0.8; radio:2.3");
	  });

	  marker.addEventListener("markerFound", () => {
		const etiqueta = nombre.toUpperCase();
		if (!progreso.encontrados.includes(etiqueta)) {
		  progreso.encontrados.push(etiqueta);
		  guardarProgreso();
		  mostrarMensaje(`¡Descubriste ${nombre}!`);
		}
	  });
	}

    activarInteraccion("img-ecoli", "orbitas-ecoli", "ecoli-marker", "E. coli");
	activarInteraccion("img-difteria", "orbitas-difteria", "difteria-marker", "Difteria");

    // --- Menú contextual ---
    const botonMenu = document.getElementById("menu");
    ["click","touchstart"].forEach(ev => {
      botonMenu.addEventListener(ev, e => {
        e.stopPropagation(); e.preventDefault();
        panel.style.display = panel.style.display === "none" ? "block" : "none";
        actualizarPanel();
        if (navigator.vibrate) navigator.vibrate(40);
      });
    });

    const botonReset = document.getElementById("reset");
    ["click","touchstart"].forEach(ev => {
      botonReset.addEventListener(ev, e => {
        e.stopPropagation(); e.preventDefault();
        localStorage.removeItem("progresoAR");
        location.reload();
      });
    });

    actualizarPanel();
  </script>
</body>
</html>
