<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AR E. coli - CCG</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #instrucciones {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      font-family: sans-serif;
      padding: 10px 20px;
      border-radius: 10px;
      z-index: 1000;
      pointer-events: none;
    }
    #menu {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
      pointer-events: auto;
    }
    #panel {
      position: fixed;
      top: 60px;
      right: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-family: sans-serif;
      display: none;
      width: 220px;
      z-index: 1000;
      pointer-events: auto;
    }
    #panel button {
      background: #00b894;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 8px;
    }
    #mensaje {
      position: fixed;
      bottom: 50%;
      left: 50%;
      transform: translate(-50%, 50%);
      background: rgba(0,255,128,0.85);
      color: black;
      padding: 10px 20px;
      border-radius: 12px;
      font-family: sans-serif;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="instrucciones">ðŸ“¸ Apunta la cÃ¡mara al QR de E. coli</div>
  <div id="menu">ðŸ“Š Progreso</div>
  <div id="panel">
    <h4>Tu progreso</h4>
    <p id="progreso">Descubiertos: 0 de 4</p>
    <p id="tiempo">Tiempo: 0 s</p>
    <button id="reset">Reiniciar</button>
  </div>
  <div id="mensaje">Â¡Descubriste E. coli! ðŸ§«</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    style="z-index:0;">
    
    <!-- Marcador personalizado -->
    <a-marker type="pattern" url="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/ecoli-qr.patt" id="ecoli-marker">
      <a-entity light="type: ambient; intensity: 2"></a-entity>

      <!-- Imagen interactiva -->
      <a-plane id="img-ecoli" class="interactivo"
        src="https://raw.githubusercontent.com/PedroAbascal/tryhtml/refs/heads/main/recursos/ecoli.png"
        height="2" width="2"
        position="0 0.5 0"
        rotation="-90 0 0"
        material="shader: flat;transparent: true;  side: double;">
      </a-plane>

      <!-- Texto informativo -->
      <a-text id="info-ecoli"
        value="Escherichia coli:\nBacteria intestinal presente en el intestino humano.\nAlgunas cepas son patÃ³genas."
        position="0 1.5 0"
		rotation="-90 0 0"
        color="#00ffaa"
        align="center"
        visible="true">
      </a-text>
    </a-marker>

    <!-- CÃ¡mara con cursor interactivo -->
    <a-entity camera look-controls>
      <a-cursor
        fuse="false"
        raycaster="objects: .interactivo"
        material="color: #00ffaa; shader: flat;"
        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015">
      </a-cursor>
    </a-entity>
  </a-scene>

  <script>
    // --- Sistema de progreso local ---
    const totalMarcas = 4;
    const progreso = JSON.parse(localStorage.getItem("progresoAR")) || { inicio: null, encontrados: [] };
    const panel = document.getElementById("panel");
    const progresoText = document.getElementById("progreso");
    const tiempoText = document.getElementById("tiempo");
    const mensaje = document.getElementById("mensaje");

    if (!progreso.inicio) progreso.inicio = Date.now();

    function actualizarPanel() {
      const segundos = Math.floor((Date.now() - progreso.inicio) / 1000);
      progresoText.textContent = `Descubiertos: ${progreso.encontrados.length} de ${totalMarcas}`;
      tiempoText.textContent = `Tiempo: ${segundos} s`;
    }

    function guardarProgreso() {
      localStorage.setItem("progresoAR", JSON.stringify(progreso));
      actualizarPanel();
    }

    function mostrarMensaje(texto) {
      mensaje.textContent = texto;
      mensaje.style.display = "block";
      setTimeout(() => mensaje.style.display = "none", 2000);
    }

    // Evento: cuando se detecta el marcador E. coli
    const ecoliMarker = document.getElementById("ecoli-marker");
    ecoliMarker.addEventListener("markerFound", () => {
      if (!progreso.encontrados.includes("E-COLI")) {
        progreso.encontrados.push("E-COLI");
        guardarProgreso();
        mostrarMensaje("Â¡Descubriste E. coli! ðŸ§«");
      }
    });

    // --- MenÃº contextual ---
    const botonMenu = document.getElementById("menu");
    ["click","touchstart"].forEach(ev => {
      botonMenu.addEventListener(ev, e => {
        e.stopPropagation(); e.preventDefault();
        panel.style.display = panel.style.display === "none" ? "block" : "none";
        actualizarPanel();
        if (navigator.vibrate) navigator.vibrate(40);
      });
    });

    const botonReset = document.getElementById("reset");
    ["click","touchstart"].forEach(ev => {
      botonReset.addEventListener(ev, e => {
        e.stopPropagation(); e.preventDefault();
        localStorage.removeItem("progresoAR");
        location.reload();
      });
    });

    // --- InteracciÃ³n sobre la imagen ---
    const imgEcoli = document.getElementById("img-ecoli");
    const infoEcoli = document.getElementById("info-ecoli");
    imgEcoli.addEventListener("click", () => {
      const visible = infoEcoli.getAttribute("visible");
      infoEcoli.setAttribute("visible", !visible);
      if (!visible && navigator.vibrate) navigator.vibrate(30);
    });

    actualizarPanel();
  </script>
</body>
</html>
