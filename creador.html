<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUAD FORGE: Dual Profile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --neon-cyan: #00f2ff;
            --neon-gold: #ffcc00;
            --neon-red: #ff0055;
            --neon-green: #00ff99;
            --neon-purple: #bc13fe;
            --dark-bg: #0d1117;
            --card-bg: #161b22;
            --input-bg: #050505;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 120px;
        }

        h1 { color: var(--neon-cyan); font-size: 1.5rem; text-align: center; margin-bottom: 5px; letter-spacing: 2px; text-transform: uppercase; }
        .subtitle { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 20px; }
        .container { max-width: 600px; margin: 0 auto; }

        /* UI COMPONENTS */
        .budget-container { position: sticky; top: 0; background: var(--dark-bg); z-index: 100; padding-bottom: 10px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .budget-bar-bg { background: #30363d; height: 12px; border-radius: 10px; overflow: hidden; border: 1px solid #444; }
        .budget-fill { height: 100%; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple)); width: 0%; transition: width 0.3s; }
        .budget-text { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; color: var(--neon-cyan); }

        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #30363d; }
        .card-header { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; color: var(--neon-gold); font-weight: bold; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }

        label { display: block; color: var(--neon-cyan); font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; margin-top: 10px; opacity: 0.8; }
        select, input, textarea { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid #333; color: white; border-radius: 6px; font-size: 1rem; outline: none; box-sizing: border-box; }
        
        /* TAGS & EXPORT */
        .tag-area { min-height: 40px; margin-top: 10px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: rgba(0, 242, 255, 0.1); color: var(--neon-cyan); padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; cursor: pointer; border: 1px solid var(--neon-cyan); }
        .export-area { margin-top: 10px; display: none; }
        .code-block { font-family: monospace; font-size: 0.8rem; background: #000; padding: 10px; border: 1px solid #333; color: var(--neon-green); width: 100%; box-sizing: border-box; height: 80px; }

        /* STATS GRID */
        .stats-matrix { 
            display: grid; 
            grid-template-columns: 20px 1fr 1fr 1fr;
            gap: 5px; 
            margin-top: 20px; 
            background: #000; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #333;
            align-items: center;
        }
        
        .matrix-row-icon { font-size: 1.2rem; text-align: center; opacity: 0.7; }
        .stat-box { text-align: center; padding: 5px; background: #0e1218; border-radius: 4px; border: 1px solid #222; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: bold; color: white; }
        .stat-lbl { font-size: 0.6rem; color: var(--text-muted); letter-spacing: 1px; }

        .stat-ranged .stat-val { color: var(--neon-cyan); }
        .stat-melee .stat-val { color: var(--neon-red); }
        .stat-def .stat-val { color: var(--neon-green); }
        .stat-cost .stat-val { color: var(--neon-gold); }
        
        .disabled-stat { opacity: 0.3; }

        .btn-add { width: 100%; padding: 14px; background: var(--neon-cyan); border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-ai { width: 100%; padding: 10px; margin-top: 10px; background: var(--neon-green); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #000; }
        .unit-item { background: #0d1117; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #555; display:flex; justify-content:space-between; align-items:center; font-size: 0.9rem;}
        .btn-del { background:none; border:1px solid #ff0055; color:#ff0055; padding:2px 8px; cursor:pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="budget-container">
        <h1>SQUAD FORGE</h1>
        <div class="subtitle">DUAL COMBAT PROFILE SYSTEM</div>
        <div class="budget-bar-bg"><div id="budget-fill" class="budget-fill"></div></div>
        <div class="budget-text"><span>PRESUPUESTO</span><span><span id="pts-current">0</span> / 100 PTS</span></div>
    </div>

    <div class="card" id="card-ai" style="border-color: var(--neon-green);">
        <div class="card-header" style="color: var(--neon-green);">‚ö° IA T√ÅCTICA</div>
        <textarea id="ai-desc" rows="2" placeholder="Ej: Orko con gran hacha..."></textarea>
        <div class="tag-area"><div class="tag-container" id="smart-tags"></div></div>
        <button class="btn-ai" onclick="analizarDescripcion()">GENERAR</button>
    </div>

    <div class="card" style="border-color: var(--neon-cyan);">
        <div class="card-header">FORJA DE OPERATIVO</div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>ID</label><select id="u-id"></select></div>
            <div style="flex:3"><label>Nombre</label><input type="text" id="u-name" value="Operativo"></div>
        </div>

        <label>1. Especie (Stats Base)</label><select id="u-species" onchange="calc()"></select>
        <label>2. Rol (Modificadores)</label><select id="u-role" onchange="calc()"></select>
        <label style="color:var(--neon-purple)">3. Habilidad</label><select id="u-ability" onchange="calc()"></select>
        
        <label>4. Armamento Principal</label>
        <select id="u-weapon" onchange="calc()"></select>
        <span id="info-weap" class="helper-text"></span>

        <div style="display:flex; gap:10px; margin-top:5px;">
            <div style="flex:1"><label>Peana</label><select id="u-base" onchange="calc()"></select></div>
            <div style="flex:1"><label>Equipo</label><select id="u-gear" onchange="calc()"></select></div>
        </div>

        <div class="stats-matrix">
            <div class="matrix-row-icon">üî´</div>
            <div class="stat-box stat-ranged" id="box-rng-atk"><span class="stat-val" id="r-atk">-</span><span class="stat-lbl">ATK</span></div>
            <div class="stat-box stat-ranged" id="box-rng-hit"><span class="stat-val" id="r-hit">-</span><span class="stat-lbl">HIT</span></div>
            <div class="stat-box stat-ranged" id="box-rng-dmg"><span class="stat-val" id="r-dmg">-</span><span class="stat-lbl">DMG</span></div>

            <div class="matrix-row-icon">‚öîÔ∏è</div>
            <div class="stat-box stat-melee"><span class="stat-val" id="m-atk">-</span><span class="stat-lbl">ATK</span></div>
            <div class="stat-box stat-melee"><span class="stat-val" id="m-hit">-</span><span class="stat-lbl">HIT</span></div>
            <div class="stat-box stat-melee"><span class="stat-val" id="m-dmg">-</span><span class="stat-lbl">DMG</span></div>

            <div class="matrix-row-icon">üõ°Ô∏è</div>
            <div class="stat-box stat-def"><span class="stat-val" id="d-hp">-</span><span class="stat-lbl">VIDA</span></div>
            <div class="stat-box stat-def"><span class="stat-val" id="d-sv">-</span><span class="stat-lbl">SAVE</span></div>
            <div class="stat-box stat-cost"><span class="stat-val" id="d-cost">-</span><span class="stat-lbl">PTS</span></div>
        </div>

        <button class="btn-add" onclick="addUnit()">A√ëADIR</button>
    </div>

    <div class="card">
        <div class="card-header">COMANDO</div>
        <div id="squad-list"></div>
        <button onclick="toggleExport()" style="width:100%; margin-top:10px; background:#333; color:white; border:1px dashed #555; padding:8px;">‚¨áÔ∏è EXPORTAR / QR</button>
        <div id="export-panel" class="export-area">
            <textarea id="export-code" class="code-block" readonly></textarea>
            <div id="qrcode" style="margin-top:10px; background:white; padding:10px; display:inline-block;"></div>
        </div>
    </div>
</div>

<script>
    // --- DATABASE COMPLETA Y EXPANDIDA ---
    const DB = {
        species: {
            human: { name: "Guardia", bs: 4, ws: 4, hp: 7, sv: 5, cost: 0, color: "#ffcc00", baseMelee: {A:3, D:2} },
            astartes: { name: "Astartes", bs: 3, ws: 3, hp: 11, sv: 3, cost: 8, color: "#00f2ff", baseMelee: {A:4, D:3} },
            ork: { name: "Orko", bs: 5, ws: 3, hp: 10, sv: 5, cost: 3, color: "#00ff99", baseMelee: {A:4, D:3} },
            eldar: { name: "Aeldari", bs: 3, ws: 4, hp: 8, sv: 4, cost: 4, color: "#bc13fe", baseMelee: {A:3, D:2} },
            necron: { name: "Necr√≥n", bs: 3, ws: 3, hp: 10, sv: 3, cost: 6, color: "#ccc", baseMelee: {A:3, D:3} },
            tyranid: { name: "Tir√°nido", bs: 4, ws: 3, hp: 9, sv: 5, cost: 3, color: "#ff0055", baseMelee: {A:4, D:3} }
        },
        roles: {
            // B√°sicos (Coste 0-1)
            trooper: { name: "Guerrero", cost: 0, modA: 0, modHit: 0, modHP: 0 },
            scout:   { name: "Explorador", cost: 1, modA: -1, modHit: -1, modHP: -1 },
            // Infanter√≠a (Coste 2)
            assault: { name: "Asalto", cost: 2, modA: 1, modHit: 0, modHP: 1 }, 
            hunter:  { name: "Cazador", cost: 2, modA: 1, modHit: 0, modHP: -1 },
            // Especialistas (Coste 3)
            sniper:  { name: "Franco", cost: 3, modA: 0, modHit: -1, modHP: -1 },
            medic:   { name: "M√©dico", cost: 3, modA: -1, modHit: 0, modHP: 2 },
            guard:   { name: "Escudo", cost: 3, modA: -1, modHit: 0, modHP: 3 },
            berserk: { name: "Fren√©tico", cost: 3, modA: 2, modHit: 1, modHP: 0 },
            // √âlites (Coste 4-5)
            heavy:   { name: "Artillero", cost: 4, modA: 0, modHit: 0, modHP: 2 },
            assassin:{ name: "Asesino", cost: 4, modA: 2, modHit: -2, modHP: -2 },
            leader:  { name: "L√≠der", cost: 5, modA: 1, modHit: -1, modHP: 3 },
            flamer:  { name: "Incendiario", cost: 5, modA: 2, modHit: 0, modHP: 1 },
            // Pesados (Coste 6+)
            tank:    { name: "Blindado", cost: 6, modA: 1, modHit: 1, modHP: 5 },
            mech:    { name: "Mecha", cost: 8, modA: 3, modHit: 0, modHP: 4 }
        },
        abilities: {
            // B√°sicas
            none:     { name: "-", cost: 0, modA: 0, modHit: 0, modHP: 0, modSV: 0 },
            // Ofensivas
            scope:    { name: "Mira L√°ser",     cost: 3, modHit: -1 },
            targeter: { name: "Visor T√°ctico",  cost: 5, modHit: -2 },
            ammo:     { name: "Munici√≥n AP",    cost: 4, modA: 2, modHit: 0 },
            rage:     { name: "Furia Ciega",    cost: 2, modA: 3, modHit: 1, modSV: 1 },
            // Defensivas
            armor:    { name: "Placas",         cost: 2, modHP: 2 },
            shield:   { name: "Campo de Fuerza",cost: 5, modHP: 1, modSV: -2 },
            reflex:   { name: "Reflejos",       cost: 3, modSV: -1 },
            regen:    { name: "Regeneraci√≥n",   cost: 6, modHP: 5, modSV: 0 },
            // T√°cticas
            stim:     { name: "Estimulantes",   cost: 2, modA: 1, modHP: -1, modSV: 0 },
            exo:      { name: "Exoesqueleto",   cost: 7, modA: 1, modHP: 3, modSV: -1 },
            scanner:  { name: "Esc√°ner",        cost: 3, modHit: -1, modSV: 0 },
            jetpack:  { name: "Propulsores",    cost: 4, modSV: -1, modHit: 0, modHP: 0 },
            voice:    { name: "Voz de Mando",   cost: 5, modHit: -1 },
            stealth:  { name: "Sigilo",         cost: 4, modSV: -1 },
            bionics:  { name: "Bi√≥nica",        cost: 3, modHP: 4 }
        },
        armas: {
            // RANGED
            pistol:     { name: "Pistola",      cost: 0, A: 3, D: 3, type: "Ranged" },
            autogun:    { name: "Rifle Auto",   cost: 1, A: 5, D: 3, type: "Ranged" },
            shotgun:    { name: "Escopeta",     cost: 2, A: 3, D: 5, type: "Ranged" },
            lasgun:     { name: "Rifle L√°ser",  cost: 0, A: 4, D: 3, type: "Ranged" },
            bolter:     { name: "B√≥lter",       cost: 2, A: 4, D: 4, type: "Ranged" },
            flamer:     { name: "Lanzallamas",  cost: 3, A: 8, D: 2, type: "Ranged" },
            grenade_l:  { name: "Lanzagranad.", cost: 3, A: 2, D: 5, type: "Ranged" },
            sniper:     { name: "Rifle Prec.",  cost: 3, A: 3, D: 5, type: "Ranged" },
            plasma:     { name: "Plasma",       cost: 4, A: 4, D: 6, type: "Ranged" },
            minigun:    { name: "Ca√±√≥n Rot.",   cost: 5, A: 6, D: 4, type: "Ranged" },
            rocket:     { name: "Lanzamisiles", cost: 5, A: 1, D: 9, type: "Ranged" },
            melta:      { name: "Fusil Fusi√≥n", cost: 4, A: 2, D: 7, type: "Ranged" },
            railgun:    { name: "Ca√±√≥n Riel",   cost: 6, A: 2, D: 8, type: "Ranged" },

            // MELEE
            staff:      { name: "Bast√≥n",       cost: 0, A: 3, D: 4, type: "Melee" },
            knife:      { name: "Cuchillo C.",  cost: 0, A: 4, D: 3, type: "Melee" },
            spear:      { name: "Lanza",        cost: 1, A: 4, D: 4, type: "Melee" },
            axe:        { name: "Hacha",        cost: 2, A: 3, D: 5, type: "Melee" },
            chainsword: { name: "Espada Sierra",cost: 2, A: 5, D: 4, type: "Melee" },
            whip:       { name: "L√°tigo E.",    cost: 3, A: 5, D: 3, type: "Melee" },
            claws:      { name: "Garras",       cost: 3, A: 6, D: 4, type: "Melee" },
            powerw:     { name: "Arma Energ√≠a", cost: 4, A: 4, D: 6, type: "Melee" },
            fist:       { name: "Pu√±o Combate", cost: 4, A: 3, D: 7, type: "Melee" },
            hammer:     { name: "Martillo T.",  cost: 5, A: 2, D: 8, type: "Melee" },
            dualblade:  { name: "Dagas Dobles", cost: 3, A: 7, D: 2, type: "Melee" }
        },
        peanas: {
            25: { name: "25mm", hpMod: 0, svMod: 0, dmgMod: 0, cost: 0 },
            32: { name: "32mm", hpMod: 3, svMod: 0, dmgMod: 0, cost: 2 },
            40: { name: "40mm", hpMod: 6, svMod: -1, dmgMod: 1, cost: 5 }
        },
        gear: {
            // Pasivos
            none:    { name: "-", cost: 0, type: "passive", uses: 0, val: 0 },
            // Supervivencia
            medkit:  { name: "Botiqu√≠n", cost: 3, type: "heal", uses: 1, target: "ally", val: 4, desc: "Cura 4 HP" },
            shield:  { name: "Escudo Energ√≠a", cost: 4, modSV: -1, type: "passive", uses: 0, target: "self", val: 0, desc: "Invulnerable 4+" },
            armor:   { name: "Placas Extra", cost: 3, modHP: 1, type: "passive", uses: 0, target: "self", val: 0, desc: "+1 Herida" },
            // Ofensivos
            granada: { name: "Granada Frag", cost: 2, type: "attack", uses: 1, target: "area", val: 5, desc: "Da√±o 5 √Årea" },
            ammo:    { name: "Munici√≥n AP", cost: 2, type: "buff", uses: 1, target: "self", val: 1, desc: "+1 Da√±o turno" },
            scope:   { name: "Mira T√°ctica", cost: 2, modHit: -1, type: "passive", uses: 0, target: "self", val: 0, desc: "+1 Impactar Disparo" },
            // Utilidad
            stim:    { name: "Estimulante", cost: 1, modA: 1, modHP: -1, type: "buff", uses: 1, target: "self", val: 2, desc: "+Mov +Atk -HP" },
            scanner: { name: "Esc√°ner", cost: 3, type: "utility", uses: 2, target: "enemy", val: 0, desc: "Ignora Cobertura" },
            smoke:   { name: "Granada Humo", cost: 2, type: "utility", uses: 1, target: "area", val: -1, desc: "Cobertura Ligera" },
            jetpack: { name: "Propulsores", cost: 5, type: "active", uses: 0, target: "self", val: 12, desc: "Vuelo 12\"" },
            // Otros
            knife:   { name: "Cuchillo Sec.", cost: 1, type: "passive", uses: 0, target: "self", val: 0 },
            camo:    { name: "Camuflaje", cost: 1, type: "passive", uses: 0, target: "self", val: 0 },
            goggles: { name: "Visor Noct.", cost: 2, type: "passive", uses: 0, target: "self", val: 0 },
            drone:   { name: "Dron Apoyo", cost: 4, type: "active", uses: 0, target: "ally", val: 0 }
        }
    };

    let state = { squad: {}, pts: 0 };
    const DEFAULT_TAGS = ["Humano", "Astartes", "Orko", "L√≠der", "Plasma", "Sierra"];

    window.onload = function() {
        fillSel('u-id', Array.from({length:16},(_,i)=>({k:i+1,v:"#"+(i+1)})));
        fillSelObj('u-species', DB.species);
        fillSelObj('u-role', DB.roles);
        fillSelObj('u-ability', DB.abilities); 
        fillSelObj('u-weapon', DB.armas);
        fillSelObj('u-base', DB.peanas);
        
        // --- AQU√ç RELLENAMOS EL EQUIPO ---
        fillSelObj('u-gear', DB.gear); 
        // ---------------------------------

        renderTags(DEFAULT_TAGS);
        document.getElementById('ai-desc').addEventListener('input', handleAI);
        load(); calc();
    };

    // --- C√ÅLCULO DUAL CON DATA-DRIVEN GEAR ---
    function calc() {
        const S = DB.species[document.getElementById('u-species').value];
        const R = DB.roles[document.getElementById('u-role').value];
        const AB = DB.abilities[document.getElementById('u-ability').value];
        const W = DB.armas[document.getElementById('u-weapon').value];
        const B = DB.peanas[document.getElementById('u-base').value];
        
        // Obtenemos el objeto G completo para leer sus modificadores
        const gearKey = document.getElementById('u-gear').value;
        const G = DB.gear[gearKey] || DB.gear.none;

        // 1. PERFIL RANGO
        let r_atk="-", r_hit="-", r_dmg="-";
        let hasGun = (W.type === 'Ranged');
        
        if (hasGun) {
            // Sumamos todos los modificadores de Hit (incluido el equipo)
            let hitVal = S.bs + R.modHit + (AB.modHit||0) + (G.modHit||0); 
            if(hitVal<2) hitVal=2; if(hitVal>6) hitVal=6;
            
            r_atk = W.A + R.modA; 
            r_hit = hitVal + "+";
            r_dmg = W.D + B.dmgMod; 
            
            document.getElementById('box-rng-atk').classList.remove('disabled-stat');
            document.getElementById('box-rng-hit').classList.remove('disabled-stat');
            document.getElementById('box-rng-dmg').classList.remove('disabled-stat');
        } else {
            document.getElementById('box-rng-atk').classList.add('disabled-stat');
            document.getElementById('box-rng-hit').classList.add('disabled-stat');
            document.getElementById('box-rng-dmg').classList.add('disabled-stat');
        }

        // 2. PERFIL MELEE
        let baseM = S.baseMelee;
        let isMeleeWeapon = (W.type === 'Melee');
        
        let m_base_A = isMeleeWeapon ? W.A : baseM.A;
        let m_base_D = isMeleeWeapon ? W.D : baseM.D;
        
        // Modificadores Globales: Ahora incluimos G.modA
        let final_m_A = m_base_A + R.modA + (AB.modA||0) + (G.modA||0);
        let final_m_D = m_base_D + B.dmgMod + (AB.modDmg||0);
        if(document.getElementById('u-species').value === 'ork') final_m_D += 1;

        // Hit Melee
        let hitM = S.ws + R.modHit + (AB.modHit||0) + (G.modHit||0);
        if(hitM<2) hitM=2; if(hitM>6) hitM=6;

        // 3. DEFENSA: Incluimos G.modHP y G.modSV
        let hp = S.hp + R.modHP + B.hpMod + (AB.modHP||0) + (G.modHP||0);
        let sv = S.sv + B.svMod + (AB.modSV||0) + (G.modSV||0);
        if(sv<2) sv=2; if(sv>6) sv=6;

        // 4. COSTO: Sumamos G.cost
        let cost = S.cost + R.cost + AB.cost + W.cost + B.cost + (G.cost||0);

        // RENDER
        document.getElementById('r-atk').innerText = r_atk;
        document.getElementById('r-hit').innerText = r_hit;
        document.getElementById('r-dmg').innerText = r_dmg;

        document.getElementById('m-atk').innerText = final_m_A;
        document.getElementById('m-hit').innerText = hitM + "+";
        document.getElementById('m-dmg').innerText = final_m_D;

        document.getElementById('d-hp').innerText = hp;
        document.getElementById('d-sv').innerText = sv + "+";
        document.getElementById('d-cost').innerText = cost;

        // INFO TEXT
        let weapDesc = hasGun ? `Disparo (${W.name})` : `Combate (${W.name})`;
        if(hasGun) weapDesc += ` + CQC B√°sico`;
        document.getElementById('info-weap').innerText = weapDesc;
    }

    // --- AGREGAR UNIDAD (CON HYDRATION DE DATOS DE JUEGO) ---
    function addUnit() {
        const cost = parseInt(document.getElementById('d-cost').innerText);
        if(state.pts + cost > 100) return alert("¬°L√≠mite excedido!");
        
        // Obtenemos datos del equipo
        const gearKey = document.getElementById('u-gear').value;
        const gearData = DB.gear[gearKey];

        const u = {
            id: document.getElementById('u-id').value,
            name: document.getElementById('u-name').value,
            spec: document.getElementById('u-species').value,
            role: document.getElementById('u-role').value,
            ability: document.getElementById('u-ability').value,
            weap: document.getElementById('u-weapon').value,
            
            // Guardamos el equipo y sus metadatos para el futuro "Modo Juego"
            gear: gearKey,
            gameplay: {
                type: gearData.type || "passive",
                uses: gearData.uses || 0,
                val: gearData.val || 0,
                target: gearData.target || "self"
            },

            stats: { 
                r_atk: document.getElementById('r-atk').innerText, 
                r_hit: document.getElementById('r-hit').innerText, 
                r_dmg: document.getElementById('r-dmg').innerText,
                m_atk: document.getElementById('m-atk').innerText, 
                m_hit: document.getElementById('m-hit').innerText, 
                m_dmg: document.getElementById('m-dmg').innerText,
                hp: document.getElementById('d-hp').innerText, 
                sv: document.getElementById('d-sv').innerText 
            },
            cost: cost
        };
        state.squad[u.id] = u; save();
    }

    function removeUnit(id) { delete state.squad[id]; save(); }
    function save(){ localStorage.setItem('sq_dual', JSON.stringify(state)); renderList(); }
    function load(){ const d=localStorage.getItem('sq_dual'); if(d){ state=JSON.parse(d); renderList(); } }

    function renderList() {
        const l = document.getElementById('squad-list'); l.innerHTML = ""; let t=0;
        Object.values(state.squad).sort((a,b)=>a.id-b.id).forEach(u => {
            t+=u.cost;
            let rngStr = (u.stats.r_atk !== '-') ? `üî´ ${u.stats.r_atk}A / ${u.stats.r_dmg}D` : '';
            
            // L√≥gica visual para el equipo
            let gearStr = "";
            if (u.gear && u.gear !== 'none') {
                let gName = DB.gear[u.gear] ? DB.gear[u.gear].name : u.gear;
                let usesStr = (u.gameplay && u.gameplay.uses > 0) ? `(x${u.gameplay.uses})` : '';
                gearStr = `<br><span style="color:var(--neon-green); font-size:0.8rem">üì¶ ${gName} ${usesStr}</span>`;
            }

            l.innerHTML += `
            <div class="unit-item" style="border-left-color:${DB.species[u.spec].color}">
                <div>
                    <strong style="color:white">#${u.id} ${u.name}</strong> 
                    <small style="color:#aaa">(${DB.species[u.spec].name} ${DB.roles[u.role].name})</small><br>
                    <div style="margin-top:2px; font-size:0.8rem; color:var(--neon-cyan)">
                        ${rngStr} ‚öîÔ∏è ${u.stats.m_atk}A / ${u.stats.m_dmg}D
                        ${gearStr}
                    </div>
                </div>
                <div style="text-align:right">
                    <span style="color:var(--neon-gold); font-weight:bold">${u.cost} pts</span>
                    <button class="btn-del" onclick="removeUnit('${u.id}')">X</button>
                </div>
            </div>`;
        });
        state.pts=t; document.getElementById('pts-current').innerText = t;
        document.getElementById('budget-fill').style.width = Math.min(t,100)+"%";
        if(document.getElementById('export-panel').style.display==='block') toggleExport();
    }

    // --- UTILIDADES ---
    function fillSel(id,arr){const s=document.getElementById(id); arr.forEach(x=>{let o=document.createElement('option');o.value=x.k;o.innerText=x.v;s.appendChild(o)});}
    function fillSelObj(id,obj){const s=document.getElementById(id); for(let k in obj){let o=document.createElement('option');o.value=k;o.innerText=obj[k].name;s.appendChild(o)}}
    
    function handleAI(e){
        const val = e.target.value.toLowerCase();
        let tags = [];
        if(val.includes("ork")) tags.push("Orko", "Frenes√≠", "Sierra");
        if(val.includes("marine")) tags.push("Astartes", "B√≥lter", "L√≠der");
        if(val.includes("lider")) tags.push("Voz Mando", "Arma Energ√≠a");
        if(tags.length === 0) tags = DEFAULT_TAGS;
        renderTags([...new Set(tags)]);
    }
    function renderTags(tags){
        const c = document.getElementById('smart-tags'); c.innerHTML="";
        tags.forEach(t=>{ let s=document.createElement('span'); s.className='tag'; s.innerText=t; s.onclick=()=>{let a=document.getElementById('ai-desc'); a.value+=" "+t; handleAI({target:a})}; c.appendChild(s); });
    }
    function analizarDescripcion(){
        let t = document.getElementById('ai-desc').value.toLowerCase();
        const set = (id,v)=>{ let el=document.getElementById(id); if(el.querySelector(`option[value="${v}"]`)) el.value=v; };
        
        if(t.includes('marine')) set('u-species','astartes');
        else if(t.includes('ork')) set('u-species','ork');
        else if(t.includes('elfo')) set('u-species','eldar');
        else if(t.includes('necron')) set('u-species','necron');
        
        if(t.includes('lider')) set('u-role','leader');
        else if(t.includes('franco')) set('u-role','sniper');
        
        if(t.includes('espada')||t.includes('sierra')) set('u-weapon','chainsword');
        else if(t.includes('plasma')) set('u-weapon','plasma');
        else if(t.includes('bolter')) set('u-weapon','bolter');
        else if(t.includes('energia')) set('u-weapon','powerw');
        
        calc();
    }

    function toggleExport(){
        let p = document.getElementById('export-panel');
        p.style.display = (p.style.display==='block')?'none':'block';
        if(p.style.display==='block'){
            document.getElementById('export-code').value = JSON.stringify(state);
            document.getElementById('qrcode').innerHTML="";
            new QRCode(document.getElementById('qrcode'), {text:JSON.stringify(state), width:100, height:100});
        }
    }
</script>
</body>
</html>
