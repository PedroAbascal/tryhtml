<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUAD COMMAND: FULL NET</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root { --c: #00f2ff; --r: #ff0055; --g: #00ff99; --gold: #ffcc00; --bg: #0d1117; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: var(--c); user-select: none; -webkit-user-select: none; }

        /* --- PANTALLAS --- */
        .screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: var(--bg); z-index: 10; transition: 0.3s; align-items: center; overflow-y: auto; }
        .screen.hidden { display: none !important; }
        
        /* --- ELEMENTOS UI --- */
        button { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--c); color: var(--c); padding: 10px 20px; font-family: inherit; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; transition: 0.2s; }
        button:active { background: var(--c); color: #000; }
        button.danger { border-color: var(--r); color: var(--r); background: rgba(255, 0, 85, 0.1); }
        input { background: #111; border: 1px solid #444; color: #fff; padding: 8px; text-align: center; font-family: inherit; margin-bottom: 10px; }

        /* --- FORGE (CREADOR) --- */
        .unit-select-card { width: 100%; border: 1px solid #444; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; background: #161b22; }
        .unit-select-card:hover { border-color: var(--c); }
        .faction-btn { width: 45%; display: inline-block; }

        /* --- HUD DE JUEGO --- */
        #hud-top { position: fixed; top: 0; left: 0; width: 100%; background: rgba(13, 17, 23, 0.95); padding: 5px; border-bottom: 1px solid #333; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- TARJETA DE UNIDAD --- */
        .card { padding: 10px; border: 1px solid #333; background: #161b22; width: 100%; margin-bottom: 10px; }
        .card.my { border-left: 3px solid var(--c); }
        .card.enemy { border-left: 3px solid var(--r); }
        .card.fatigued { opacity: 0.7; border-left-color: #888; }
        .card.exhausted { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        /* --- BURBUJAS UNIFICADAS --- */
        .hud-container { position: fixed; z-index: 1000; display: flex; align-items: flex-start; gap: 10px; transition: opacity 0.3s; }
        .hud-bubble { width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, #444, #111); border: 2px solid #666; border-radius: 50%; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .hud-bubble.active { border-color: var(--c); box-shadow: 0 0 15px var(--c); }
        .hud-menu { background: rgba(10, 10, 10, 0.95); border: 1px solid #444; border-radius: 8px; padding: 8px; min-width: 160px; display: flex; flex-direction: column; gap: 6px; backdrop-filter: blur(4px); }
        .hud-menu.hidden { display: none !important; }
        .menu-item { background: #222; border: 1px solid #333; padding: 8px 10px; border-radius: 4px; color: #eee; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- DADOS Y OVERLAY --- */
        #dice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .dice-pool { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 10px; min-height: 60px; }
        .die { width: 45px; height: 45px; background: #fff; color: #000; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; border: 2px solid #000; }
        .die.crit { background: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .tag { font-size: 0.7rem; padding: 2px 4px; border: 1px solid #444; margin: 1px; display: inline-block; }
    </style>
</head>
<body>

    <div id="lobby-screen" class="screen">
        <h1 style="text-shadow: 0 0 10px var(--c);">SQUAD COMMAND</h1>
        <div style="background:#111; padding:20px; border:1px solid #333; width:90%; max-width:400px;">
            <p>CONFIGURACI√ìN DE RED</p>
            <input type="text" id="net-channel" placeholder="CANAL (Ej: MESA_1)" value="MESA_TEST">
            <input type="text" id="net-player" placeholder="TU NOMBRE" value="JUGADOR_1">
            <div id="connection-status" style="font-size:0.7rem; color:#555; margin-bottom:10px;">Desconectado</div>
            <button onclick="connectAndPlay()" style="width:100%">CONECTAR Y JUGAR</button>
        </div>
        <br>
        <button onclick="openForge()">IR AL FORGE (CREAR LISTA)</button>
    </div>

    <div id="creator-screen" class="screen hidden">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <h2>FORGE</h2>
            <span id="army-points" style="color:var(--gold)">0 PTS</span>
        </div>
        
        <div style="width:100%; text-align:center; margin-bottom:10px;">
            <button class="faction-btn" onclick="setFaction('ASTARTES')">ASTARTES</button>
            <button class="faction-btn" onclick="setFaction('NECRON')">NECRON</button>
        </div>

        <h3>TU LISTA:</h3>
        <div id="my-army-list" style="width:100%; min-height:100px; border:1px dashed #444; padding:5px;"></div>
        
        <h3>DISPONIBLES:</h3>
        <div id="available-units" style="width:100%;"></div>

        <div style="margin-top:20px; width:100%; display:flex; justify-content:space-around;">
            <button class="danger" onclick="returnToLobby()">SALIR</button>
            <button onclick="confirmArmy()">DESPLEGAR</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden" style="justify-content: flex-start; padding-top: 60px;">
        <div id="hud-top">
            <div>
                <span id="my-name" style="font-weight:bold; font-size:1.1rem;">-</span>
                <div style="width:100px; height:6px; background:#333; margin-top:2px;">
                    <div id="my-hp" style="width:100%; height:100%; background:var(--g); transition:0.3s;"></div>
                </div>
            </div>
            <div style="text-align:right;">
                <span id="cp-display" style="color:var(--gold);">CP: 2</span><br>
                <span id="turn-indicator" style="font-size:0.7rem; color:#888;">ESPERANDO...</span>
            </div>
        </div>

        <div id="my-card" class="card my">
            <div style="display:flex; justify-content:space-between;">
                <span id="my-status-text">LISTO</span>
                <small id="my-sv">SV 3+</small>
            </div>
            <div id="my-tags" style="margin-top:5px;"></div>
        </div>

        <div style="flex:1; width:100%; display:flex; align-items:center; justify-content:center; border:1px solid #222; color:#333;">
            <div style="text-align:center;">
                <p>ZONA DE COMBATE</p>
                <p id="net-log" style="font-size:0.7rem; color:var(--c); max-width:300px;">...</p>
            </div>
        </div>

        <div id="hud-cmd" class="hud-container" style="top: 80px; left: 10px; display:none;">
            <div class="hud-bubble" onclick="toggleBubble('cmd')">
                <span class="bubble-icon">CP</span><small class="bubble-label">PLOYS</small>
            </div>
            <div id="menu-cmd" class="hud-menu hidden"></div>
        </div>

        <div id="hud-gear" class="hud-container" style="top: 150px; left: 10px; display:none;">
            <div class="hud-bubble" onclick="toggleBubble('gear')">
                <span class="bubble-icon">üéí</span><small class="bubble-label">ITEM</small>
            </div>
            <div id="menu-gear" class="hud-menu hidden"></div>
        </div>

        <div id="hud-act" class="hud-container" style="bottom: 20px; left: 10px; display:none;">
            <div class="hud-bubble" onclick="toggleBubble('act')">
                <span id="act-icon-display" class="bubble-icon">‚ö°</span><small class="bubble-label">ACT</small>
            </div>
            <div id="menu-act" class="hud-menu hidden"></div>
        </div>
    </div>

    <div id="dice-overlay">
        <h2 id="combat-title" style="color:var(--c)">COMBATE</h2>
        <div id="combat-log-visual" style="font-size:0.8rem; color:#aaa; margin-bottom:10px;"></div>
        
        <div class="dice-pool" id="pool-atk"></div>
        <div class="dice-pool" id="pool-def"></div>
        
        <div id="combat-controls" style="margin-top:20px;">
            <button id="btn-confirm-atk" onclick="confirmAttack()" style="display:none;">CONFIRMAR ATAQUE</button>
            <button id="btn-confirm-def" onclick="confirmDefense()" style="display:none;">TIRAR DEFENSA</button>
            <button id="btn-apply-dmg" class="danger" onclick="applyCombatResult()" style="display:none;">APLICAR DA√ëO</button>
            <button id="btn-close-combat" onclick="closeCombatOverlay()" style="margin-top:10px; display:none;">CERRAR</button>
        </div>
    </div>

    <script>
        // =============================================================
        // 1. BASES DE DATOS (UNIDADES, ARMAS, EQUIPO)
        // =============================================================
        
        // UNIDADES PARA EL FORGE
        const UNIT_DB = {
            ASTARTES: [
                { id: "int_sgt", name: "Sargento Intercesor", pts: 15, stats: { m: 6, sv: 3, df: 3 }, hp: 14, weapons: ["bolt_rifle", "chainsword"], keywords: ["LEADER", "IMPERIUM"] },
                { id: "int_war", name: "Guerrero Intercesor", pts: 12, stats: { m: 6, sv: 3, df: 3 }, hp: 13, weapons: ["bolt_rifle", "fists"], keywords: ["IMPERIUM"] },
                { id: "ass_int", name: "Asalto Intercesor",   pts: 13, stats: { m: 6, sv: 3, df: 3 }, hp: 13, weapons: ["heavy_pistol", "chainsword"], keywords: ["IMPERIUM"] }
            ],
            NECRON: [
                { id: "nec_imm", name: "Inmortal Gauss",      pts: 14, stats: { m: 4, sv: 3, df: 3 }, hp: 12, weapons: ["gauss_blaster", "fists"], keywords: ["NECRON"] },
                { id: "nec_war", name: "Guerrero Necron",     pts: 10, stats: { m: 4, sv: 4, df: 3 }, hp: 10, weapons: ["gauss_flayer", "fists"], keywords: ["NECRON"] }
            ]
        };

        const WEAPON_DB = {
            "bolt_rifle":    { name: "Rifle B√≥lter",  type: "RANGED", atk: 4, hit: 3, dmg: 3, traits: ["BALANCED"] },
            "heavy_pistol":  { name: "Pistola Pesada",type: "RANGED", atk: 4, hit: 3, dmg: 4, traits: ["PISTOL"] },
            "gauss_blaster": { name: "Blaster Gauss", type: "RANGED", atk: 4, hit: 3, dmg: 4, traits: ["AP_1"] },
            "gauss_flayer":  { name: "Desollador",    type: "RANGED", atk: 4, hit: 3, dmg: 3, traits: [] },
            "chainsword":    { name: "Espada Sierra", type: "MELEE",  atk: 5, hit: 3, dmg: 4, traits: [] },
            "fists":         { name: "Pu√±os",         type: "MELEE",  atk: 3, hit: 3, dmg: 3, traits: [] }
        };

        const GEAR_DB = {
            "none":   { name: "Nada", cost: 0, keywords: [] },
            "nades":  { name: "Granadas Frag", cost: 2, keywords: ["GRENADIER"], mechanicRef: "grenade" },
            "medkit": { name: "Medkit",        cost: 3, keywords: ["MEDIC"],     mechanicRef: "medkit" }
        };

        const MECHANICS_DB = {
            "grenade": { name: "GRANADA", icon: "üí£", type: "ACTIVE", func: "startAttack", params: "grenade", oneUse: true },
            "medkit":  { name: "MEDKIT",  icon: "üíä", type: "ACTIVE", func: "useMedkit",    oneUse: true }
        };

        const PLOYS_DB = [
            { id: "reroll", name: "RE-ROLL T√ÅCTICO", cost: 1, desc: "Repite 1 dado.", func: "activateCPReroll" },
            { id: "dash",   name: "SPRINT (DASH)",   cost: 1, desc: "+Movimiento.",   func: "activateDash" }
        ];

        // =============================================================
        // 2. GESTI√ìN DE RED (MQTT)
        // =============================================================
        let client;
        let myChannel = "MESA_DEFAULT";
        let myPlayerID = "Player_" + Math.floor(Math.random()*1000);
        let isConnected = false;

        function connectAndPlay() {
            myChannel = document.getElementById('net-channel').value || "MESA_TEST";
            myPlayerID = document.getElementById('net-player').value || "Unknown";
            
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, myPlayerID + "_" + Math.random());
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            document.getElementById('connection-status').innerText = "Conectando...";
            
            client.connect({
                onSuccess: onConnect,
                onFailure: (e) => { alert("Error Conexi√≥n: " + e.errorMessage); }
            });
        }

        function onConnect() {
            console.log("MQTT Conectado");
            isConnected = true;
            document.getElementById('connection-status').innerText = "CONECTADO A: " + myChannel;
            document.getElementById('connection-status').style.color = "var(--g)";
            
            client.subscribe(myChannel + "/#");
            publish({ type: 'JOIN', sender: myPlayerID });
            
            // Si conectamos desde el lobby, vamos al forge
            if(document.getElementById('game-screen').classList.contains('hidden')) {
                openForge();
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) console.log("Conexi√≥n perdida:"+responseObject.errorMessage);
            document.getElementById('connection-status').innerText = "DESCONECTADO";
            document.getElementById('connection-status').style.color = "var(--r)";
        }

        function publish(payload) {
            if(!isConnected) return;
            const message = new Paho.MQTT.Message(JSON.stringify(payload));
            message.destinationName = myChannel + "/game";
            client.send(message);
        }

        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                if(data.sender === myPlayerID) return; // Ignorar mis propios mensajes

                // LOGICA DE RECEPCI√ìN
                document.getElementById('net-log').innerText = `RIVAL: ${data.type}`;

                if (data.type === 'COMBAT_SYNC') {
                    handleCombatSync(data);
                } else if (data.type === 'TURN_PASS') {
                    alert("Tu Rival pas√≥ turno. ¬°Es tu turno!");
                    // Aqu√≠ l√≥gica de cambio de turno real
                }
            } catch(e) { console.error("Error msg", e); }
        }

        // =============================================================
        // 3. LOGICA DEL FORGE (CREADOR)
        // =============================================================
        let myArmy = [];
        let currentPoints = 0;

        window.openForge = function() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('creator-screen').classList.remove('hidden');
            toggleCombatHUD(false); // Ocultar burbujas en forge
            setFaction('ASTARTES'); // Default
        };

        window.returnToLobby = function() {
            document.getElementById('creator-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
        };

        window.setFaction = function(faction) {
            const container = document.getElementById('available-units');
            container.innerHTML = '';
            
            if(!UNIT_DB[faction]) return;

            UNIT_DB[faction].forEach(u => {
                const div = document.createElement('div');
                div.className = "unit-select-card";
                div.innerHTML = `
                    <span><b>${u.name}</b> (${u.pts} pts)</span>
                    <button style="padding:4px 8px; font-size:0.8rem;" onclick="addToArmy('${faction}', '${u.id}')">+</button>
                `;
                container.appendChild(div);
            });
        };

        window.addToArmy = function(faction, uid) {
            const template = UNIT_DB[faction].find(u => u.id === uid);
            // Copia profunda para editar
            const newUnit = JSON.parse(JSON.stringify(template));
            
            // Asignar UID √∫nico
            newUnit.uid = "u_" + Math.floor(Math.random()*10000);
            
            // Resolver Armas (De string a objeto real)
            newUnit.weapons = newUnit.weapons.map(wId => {
                return WEAPON_DB[wId] ? { ...WEAPON_DB[wId] } : { name: "Desconocido", atk:1, hit:6, dmg:1, type:"MELEE" };
            });

            // Default Gear
            newUnit.gear = "nades"; // Ejemplo default
            newUnit.gearUsed = false;
            newUnit.ap = 2;
            newUnit.activations = 0;

            myArmy.push(newUnit);
            updateArmyListUI();
        };

        function updateArmyListUI() {
            const list = document.getElementById('my-army-list');
            list.innerHTML = '';
            currentPoints = 0;
            
            myArmy.forEach((u, idx) => {
                currentPoints += u.pts;
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:4px;";
                div.innerHTML = `<span>${u.name}</span> <small onclick="removeFromArmy(${idx})" style="color:var(--r); cursor:pointer;">[X]</small>`;
                list.appendChild(div);
            });
            document.getElementById('army-points').innerText = currentPoints + " PTS";
        }

        window.removeFromArmy = function(idx) {
            myArmy.splice(idx, 1);
            updateArmyListUI();
        };

        window.confirmArmy = function() {
            if(myArmy.length === 0) { alert("A√±ade unidades primero."); return; }
            myUnits = myArmy; // Transferir al juego
            startGame();
        };

        // =============================================================
        // 4. L√ìGICA DE JUEGO (GAME LOOP & UI UNIFICADA)
        // =============================================================
        let myUnits = [];
        let myIdx = 0;
        let myCP = 2;
        let combatMode = 'ranged';
        let currentBubble = null;
        let activeCombatStats = {};
        let atkRolls = [], defRolls = [];

        function startGame() {
            document.getElementById('creator-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            // Inicializar UI
            toggleCombatHUD(true); // <--- IMPORTANTE: Mostrar burbujas
            updateHUD();
            
            // Avisar a red
            publish({ type: 'GAME_START', armySize: myUnits.length });
        }

        // --- SISTEMA DE BURBUJAS UNIFICADO ---
        window.toggleBubble = function(type) {
            if (currentBubble === type) {
                closeAllBubbles();
            } else {
                closeAllBubbles();
                currentBubble = type;
                document.querySelector(`#hud-${type} .hud-bubble`)?.classList.add('active');
                document.getElementById(`menu-${type}`)?.classList.remove('hidden');
                refreshActiveMenu();
            }
        };

        function closeAllBubbles() {
            currentBubble = null;
            document.querySelectorAll('.hud-bubble').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.hud-menu').forEach(el => el.classList.add('hidden'));
        }

        function toggleCombatHUD(show) {
            const val = show ? 'flex' : 'none';
            document.getElementById('hud-cmd').style.display = val;
            document.getElementById('hud-gear').style.display = val;
            document.getElementById('hud-act').style.display = val;
            if(!show) closeAllBubbles();
        }

        window.refreshActiveMenu = function() {
            if (currentBubble === 'cmd') renderCmdMenu();
            else if (currentBubble === 'gear') renderGearMenu();
            else if (currentBubble === 'act') renderActMenu();
        };

        // --- RENDERIZADORES DE MEN√öS ---
        window.renderActMenu = function() {
            const container = document.getElementById('menu-act');
            container.innerHTML = '';
            const me = myUnits[myIdx];
            
            const acts = [
                { name: "MOVER", icon: "üèÉ", cost: 1, disabled: me.ap<1 || me.hasMoved, func: "startMove" },
                { name: "DISPARAR", icon: "üî´", cost: 1, disabled: me.ap<1 || me.hasShot, func: "startShooting" },
                { name: "COMBATE", icon: "‚öîÔ∏è", cost: 1, disabled: me.ap<1 || me.hasFought, func: "startMelee" },
                { name: "PASAR", icon: "‚è≠Ô∏è", cost: 0, disabled: false, func: "passTurn" }
            ];

            acts.forEach(act => {
                const div = document.createElement('div');
                div.className = act.disabled ? "menu-item disabled" : "menu-item";
                div.innerHTML = `<span>${act.icon} ${act.name}</span>`;
                if(!act.disabled) {
                    div.onclick = () => { window[act.func](); toggleBubble(null); };
                }
                container.appendChild(div);
            });
        };

        window.renderGearMenu = function() {
            const container = document.getElementById('menu-gear');
            container.innerHTML = '';
            const me = myUnits[myIdx];
            const gInfo = GEAR_DB[me.gear] || GEAR_DB["none"];
            
            if(!gInfo.mechanicRef) {
                container.innerHTML = '<div style="color:#777; padding:5px;">Vac√≠o</div>'; return;
            }
            
            const mech = MECHANICS_DB[gInfo.mechanicRef];
            const isUsed = me.gearUsed && mech.oneUse;
            
            const div = document.createElement('div');
            div.className = isUsed ? "menu-item disabled" : "menu-item";
            div.innerHTML = `<span>${mech.icon} ${mech.name}</span><small>${isUsed?'USADO':'USAR'}</small>`;
            
            if(!isUsed) {
                div.onclick = () => {
                    console.log("Usando", mech.name);
                    if(mech.func === 'startAttack') initiateCombat(0); // Hack para granada
                    if(mech.oneUse) me.gearUsed = true;
                    toggleBubble(null); updateHUD();
                };
            }
            container.appendChild(div);
        };

        window.renderCmdMenu = function() {
            const container = document.getElementById('menu-cmd');
            container.innerHTML = `<div style="border-bottom:1px solid #333; color:var(--gold); font-size:0.7rem;">CP: ${myCP}</div>`;
            
            PLOYS_DB.forEach(p => {
                const can = myCP >= p.cost;
                const div = document.createElement('div');
                div.className = can ? "menu-item" : "menu-item disabled";
                div.innerHTML = `<span>${p.name}</span><span style="color:var(--gold)">${p.cost}</span>`;
                if(can) {
                    div.onclick = () => {
                        if(confirm("¬øGastar CP?")) { myCP -= p.cost; window[p.func](); updateHUD(); toggleBubble(null); }
                    };
                }
                container.appendChild(div);
            });
        };

        // --- UPDATE HUD CENTRAL ---
        window.updateHUD = function() {
            if(!myUnits.length) return;
            const me = myUnits[myIdx];

            document.getElementById('my-name').innerText = me.name;
            document.getElementById('my-hp').style.width = (me.hp / 14 * 100) + "%"; // Mock HP calc
            document.getElementById('cp-display').innerText = "CP: " + myCP;
            
            const card = document.getElementById('my-card');
            card.className = "card my";
            if(me.activations >= 2) card.classList.add('exhausted');

            // Render Tags/Weapons
            const tagContainer = document.getElementById('my-tags');
            tagContainer.innerHTML = '';
            me.weapons.forEach(w => {
                let active = (w.type === 'RANGED' && combatMode === 'ranged') || (w.type === 'MELEE' && combatMode === 'melee');
                const div = document.createElement('div');
                div.className = "tag";
                div.style.cssText = `display:block; width:95%; border-color:${active?'var(--c)':'#444'}; cursor:pointer;`;
                div.innerHTML = `<b>${w.name}</b> A:${w.atk} H:${w.hit}+`;
                div.onclick = () => { combatMode = w.type === 'RANGED' ? 'ranged' : 'melee'; updateHUD(); };
                tagContainer.appendChild(div);
            });
            
            document.getElementById('act-icon-display').innerText = combatMode === 'ranged' ? "üî´" : "‚öîÔ∏è";
            
            refreshActiveMenu();
        };

        // =============================================================
        // 5. ACCIONES DE JUEGO
        // =============================================================
        window.startMove = function() {
            const me = myUnits[myIdx];
            if(confirm("¬øMover? (-1 AP)")) { me.hasMoved=true; me.ap--; updateHUD(); }
        };
        window.startShooting = function() {
            const me = myUnits[myIdx];
            const wIdx = me.weapons.findIndex(w => w.type === 'RANGED');
            if(wIdx === -1) { alert("Sin disparo"); return; }
            combatMode='ranged'; me.hasShot=true; me.ap--;
            initiateCombat(wIdx); updateHUD();
        };
        window.startMelee = function() {
            const me = myUnits[myIdx];
            const wIdx = me.weapons.findIndex(w => w.type === 'MELEE');
            combatMode='melee'; me.hasFought=true; me.ap--;
            initiateCombat(wIdx!==-1?wIdx:0); updateHUD();
        };
        window.passTurn = function() {
            if(confirm("¬øPasar Turno?")) {
                const me = myUnits[myIdx];
                me.activations++; me.ap=0;
                me.hasMoved=false; me.hasShot=false; me.hasFought=false;
                toggleCombatHUD(false);
                publish({type: 'TURN_PASS'});
                updateHUD();
            }
        };

        // =============================================================
        // 6. CORE DE COMBATE (RED INCLUIDA)
        // =============================================================
        window.initiateCombat = function(wIdx) {
            const me = myUnits[myIdx];
            const w = me.weapons[wIdx];
            
            activeCombatStats = { name: w.name, hit: w.hit, dmg: w.dmg, traits: w.traits };
            
            document.getElementById('dice-overlay').style.display = 'flex';
            document.getElementById('combat-title').innerText = "ATAQUE: " + w.name;
            document.getElementById('btn-confirm-atk').style.display = 'inline-block';
            document.getElementById('btn-confirm-def').style.display = 'none';
            document.getElementById('btn-apply-dmg').style.display = 'none';
            document.getElementById('btn-close-combat').style.display = 'inline-block';
            document.getElementById('btn-close-combat').innerText = "CANCELAR";
            document.getElementById('pool-def').innerHTML = '';

            // Dados
            atkRolls = [];
            for(let i=0; i<w.atk; i++) atkRolls.push(Math.ceil(Math.random()*6));
            renderDice(atkRolls, 'pool-atk');
            
            publish({ type: 'COMBAT_SYNC', stage: 'PRE_ATK', uName: me.name, wName: w.name, rolls: atkRolls });
        };

        window.confirmAttack = function() {
            document.getElementById('btn-confirm-atk').style.display = 'none';
            document.getElementById('combat-log-visual').innerText = "Enviando ataque al rival...";
            
            // Calc hits basicos
            let hits = 0; let crits = 0;
            atkRolls.forEach(r => { if(r==6) crits++; else if(r>=activeCombatStats.hit) hits++; });
            
            publish({ 
                type: 'COMBAT_SYNC', stage: 'ATK_CONFIRMED', 
                hits: hits, crits: crits, dmg: activeCombatStats.dmg, 
                rolls: atkRolls 
            });
        };

        window.handleCombatSync = function(d) {
            document.getElementById('dice-overlay').style.display = 'flex';
            document.getElementById('btn-close-combat').style.display = 'none';
            
            if(d.stage === 'PRE_ATK') {
                document.getElementById('combat-title').innerText = "DEFENDIENDO vs " + d.wName;
                renderDice(d.rolls, 'pool-atk');
                document.getElementById('combat-log-visual').innerText = "El rival est√° tirando...";
            }
            if(d.stage === 'ATK_CONFIRMED') {
                renderDice(d.rolls, 'pool-atk');
                document.getElementById('combat-log-visual').innerText = `Entran: ${d.crits} Crits, ${d.hits} Hits. ¬°TIRA DEFENSA!`;
                document.getElementById('btn-confirm-def').style.display = 'inline-block';
                
                // Guardar datos entrantes para calcular da√±o
                activeCombatStats.incoming = { hits: d.hits, crits: d.crits, dmg: d.dmg };
                
                // Tirar mis dados def (Mock 3 dados)
                defRolls = [];
                for(let i=0; i<3; i++) defRolls.push(Math.ceil(Math.random()*6));
                renderDice(defRolls, 'pool-def');
            }
            if(d.stage === 'RESOLVED') {
                renderDice(d.defRolls, 'pool-def');
                document.getElementById('combat-log-visual').innerText = `Rival defendi√≥. Da√±o final: ${d.finalDmg}`;
                document.getElementById('btn-close-combat').style.display = 'inline-block';
                document.getElementById('btn-close-combat').innerText = "CERRAR";
            }
        };

        window.confirmDefense = function() {
            document.getElementById('btn-confirm-def').style.display = 'none';
            
            // L√≥gica simple de defensa (saves bloquean hits)
            let saves = defRolls.filter(r => r >= 3).length; // SV 3+ fijo por ahora
            let inc = activeCombatStats.incoming;
            
            let totalHits = inc.hits + inc.crits;
            let finalHits = Math.max(0, totalHits - saves);
            let finalDmg = finalHits * inc.dmg;

            document.getElementById('btn-apply-dmg').style.display = 'inline-block';
            document.getElementById('btn-apply-dmg').innerText = `RECIBIR ${finalDmg} DA√ëO`;
            document.getElementById('btn-apply-dmg').dataset.dmg = finalDmg;
            
            publish({ type: 'COMBAT_SYNC', stage: 'RESOLVED', finalDmg: finalDmg, defRolls: defRolls });
        };

        window.applyCombatResult = function() {
            const dmg = parseInt(document.getElementById('btn-apply-dmg').dataset.dmg);
            const me = myUnits[myIdx];
            me.hp = Math.max(0, me.hp - dmg);
            updateHUD();
            closeCombatOverlay();
        };

        window.closeCombatOverlay = function() {
            document.getElementById('dice-overlay').style.display = 'none';
        };

        function renderDice(arr, id) {
            const c = document.getElementById(id); c.innerHTML = '';
            arr.forEach(r => {
                const d = document.createElement('div');
                d.className = r==6 ? 'die crit' : 'die';
                d.innerText = r;
                c.appendChild(d);
            });
        }
        
        // PLOYS UTILS
        window.activateCPReroll = () => alert("Reroll activado");
        window.activateDash = () => { myUnits[myIdx].ap++; updateHUD(); };

    </script>
</body>
</html>
