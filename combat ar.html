<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUAD COMMAND: VERSUS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --hud-cyan: #00f2ff;
            --hud-red: #ff0055;
            --hud-gold: #ffcc00;
            --hud-green: #00ff99;
            --hud-bg: rgba(0, 10, 20, 0.9);
        }

        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: var(--hud-cyan); user-select: none; }

        /* VIDEO & SCANLINE */
        #ar-feed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: contrast(1.1) brightness(0.8); }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: rgba(0, 242, 255, 0.3); animation: scan 3s linear infinite; z-index: 0; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; opacity:0; } 100% { top: 100%; opacity:0; } }

        /* SCREENS */
        .screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0; box-sizing: border-box; background: #0d1117; z-index: 10; transition: 0.3s; }
        .screen.hidden { display: none !important; }
        .screen.transparent { background: transparent; pointer-events: none; }
        
        /* LOBBY */
        #lobby-screen { align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .lobby-box { border: 1px solid var(--hud-cyan); padding: 20px; width: 90%; max-width: 400px; background: rgba(0,0,0,0.85); }
        textarea { width: 100%; height: 60px; background:#111; color:#aaa; border:1px solid #333; font-size:0.7rem; font-family:monospace; }
        input { background: #111; border: 1px solid #555; color: white; padding: 10px; font-family: monospace; width: 70%; text-transform: uppercase; margin-top:5px;}
        .btn-main { background: var(--hud-cyan); color: #000; border: none; padding: 15px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-sec { background: transparent; border: 1px solid var(--hud-cyan); color: var(--hud-cyan); padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; }

        /* HUD */
        .hud-top { display: flex; justify-content: space-between; padding: 10px; pointer-events: auto; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .status-pill { border: 1px solid #555; padding: 5px 10px; font-size: 0.7rem; background: rgba(0,0,0,0.5); color:#888; }
        .status-pill.active { border-color: var(--hud-green); color: var(--hud-green); }

        .hud-bottom { position: absolute; bottom: 0; width: 100%; padding: 10px; box-sizing: border-box; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto; }
        
        .unit-card { border: 1px solid #333; padding: 10px; margin-bottom: 5px; background: rgba(0,0,0,0.6); transition: 0.2s; cursor: pointer; }
        .unit-card.my-unit { border-left: 4px solid var(--hud-cyan); }
        .unit-card.enemy-unit { border-left: 4px solid var(--hud-red); }
        .unit-card:active { transform: scale(0.98); }

        .hp-bar { height: 4px; background: #333; margin-top: 5px; width: 100%; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.3s; }
        
        .btn-fire { width: 100%; background: var(--hud-red); color: white; border: none; padding: 15px; font-size: 1.5rem; font-weight: bold; margin-top: 10px; clip-path: polygon(5% 0, 100% 0, 100% 100%, 0 100%, 0 30%); cursor: pointer; }
        
        #combat-log { position: absolute; top: 60px; left: 10px; width: 60%; font-size: 0.7rem; text-shadow: 1px 1px 0 #000; pointer-events: none; }
        .log-entry { margin-bottom: 2px; opacity: 0.9; }
        .log-hit { color: var(--hud-cyan); } .log-dmg { color: var(--hud-red); font-weight:bold; }

        /* WAITING OVERLAY */
        #wait-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--hud-cyan); display:none; }
    </style>
</head>
<body>

    <video id="ar-feed" autoplay playsinline muted></video>
    <div class="scan-line"></div>

    <div id="wait-overlay">
        <h2>SINCRONIZANDO...</h2>
        <p>Intercambiando datos de escuadra</p>
        <div style="font-size:2rem;">‚áÑ</div>
    </div>

    <div id="lobby-screen" class="screen">
        <h1 style="color:var(--hud-cyan); margin-bottom:5px;">SQUAD VERSUS</h1>
        <div style="font-size:0.7rem; color:#888; margin-bottom:20px;">DEPLOYMENT LINK v4.0</div>

        <div class="lobby-box">
            <h3 style="color:var(--hud-green)">TU ESCUADRA (JSON)</h3>
            <textarea id="json-input" placeholder='Pega AQU√ç el JSON de TU escuadra (generado en Squad Forge)'></textarea>
            
            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">

            <div id="host-section">
                <button class="btn-main" onclick="startHost()">CREAR PARTIDA (HOST)</button>
                <div id="host-code-display" style="display:none; margin-top:10px;">
                    <span style="color:#aaa">TU C√ìDIGO:</span><br>
                    <span id="my-code" style="color:var(--hud-gold); font-size:1.5rem; font-weight:bold;">...</span>
                    <p style="font-size:0.7rem; color:#666">Esperando al rival...</p>
                </div>
            </div>

            <p style="color:#555">- O -</p>

            <div id="join-section">
                <input type="text" id="join-code" placeholder="C√ìDIGO RIVAL">
                <button class="btn-sec" onclick="startJoin()">UNIRSE</button>
            </div>
            <p id="status-msg" style="color:var(--hud-red); font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="hud-screen" class="screen transparent hidden">
        <div class="hud-top">
            <div class="status-pill active" id="role-indicator">---</div>
            <div class="status-pill active">LIVE LINK</div>
        </div>

        <div id="combat-log"></div>

        <div class="hud-bottom">
            <div class="unit-card my-unit" onclick="nextMyUnit()">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--hud-cyan);">
                    <span>YO (MIS TROPAS)</span> <span id="my-stats">---</span>
                </div>
                <div id="my-name" style="font-weight:bold;">Seleccionando...</div>
                <div class="hp-bar"><div id="my-hp" class="hp-fill" style="background:var(--hud-cyan)"></div></div>
            </div>

            <div class="unit-card enemy-unit" onclick="nextEnemyUnit()">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--hud-red);">
                    <span>RIVAL (OBJETIVO)</span> <span id="enemy-stats">---</span>
                </div>
                <div id="enemy-name" style="font-weight:bold;">Seleccionando...</div>
                <div class="hp-bar"><div id="enemy-hp" class="hp-fill" style="background:var(--hud-red)"></div></div>
            </div>

            <button class="btn-fire" onclick="fireWeapon()">ABRIR FUEGO</button>
        </div>
    </div>

<script>
    // --- ESTADO GLOBAL ---
    let myRole = null; // 'host' o 'guest'
    let myRawData = null; // Mi JSON original
    
    // Almacenes de unidades procesadas
    let myUnits = [];     
    let enemyUnits = [];
    
    // √çndices de selecci√≥n
    let myIdx = 0;
    let enemyIdx = 0;

    // Estado de vida global (Key: uniqueID, Value: HP)
    let globalHP = {};

    // Red
    let peer = null;
    let conn = null;

    // --- 1. SETUP & VALIDACI√ìN ---
    function getLocalSquad() {
        const raw = document.getElementById('json-input').value;
        if(!raw) { alert("¬°Debes pegar tu JSON de escuadra primero!"); return null; }
        try {
            const data = JSON.parse(raw);
            return Object.values(data.squad); // Array de unidades
        } catch(e) {
            alert("JSON inv√°lido"); return null;
        }
    }

    // --- 2. CONEXI√ìN P2P ---
    function startHost() {
        const squad = getLocalSquad();
        if(!squad) return;
        myRawData = squad;
        myRole = 'host';

        document.getElementById('status-msg').innerText = "Iniciando red...";
        const id = "SQ-" + Math.floor(Math.random()*9999);
        peer = new Peer(id);

        peer.on('open', (pid) => {
            document.getElementById('host-code-display').style.display = 'block';
            document.getElementById('my-code').innerText = pid;
            document.getElementById('join-section').style.display = 'none';
        });

        peer.on('connection', (c) => {
            conn = c;
            handleConnection();
        });
    }

    function startJoin() {
        const squad = getLocalSquad();
        if(!squad) return;
        myRawData = squad;
        myRole = 'guest';

        const target = document.getElementById('join-code').value;
        if(!target) return alert("Falta c√≥digo");

        peer = new Peer(); // ID autom√°tico para el guest
        peer.on('open', () => {
            conn = peer.connect(target);
            handleConnection();
        });
    }

    // --- 3. HANDSHAKE (INTERCAMBIO DE DATOS) ---
    function handleConnection() {
        document.getElementById('wait-overlay').style.display = 'flex';

        conn.on('open', () => {
            console.log("Conectado. Enviando mi escuadra...");
            // ENVIAR MI ESCUADRA AL RIVAL
            conn.send({
                type: 'HANDSHAKE',
                role: myRole,
                squad: myRawData
            });
        });

        conn.on('data', (data) => {
            console.log("Datos recibidos:", data.type);
            
            if (data.type === 'HANDSHAKE') {
                // RECIBIMOS LA ESCUADRA ENEMIGA
                processGameStart(myRawData, data.squad);
            }
            else if (data.type === 'ATTACK') {
                // RECIBIMOS UN ATAQUE
                resolveIncomingAttack(data);
            }
            else if (data.type === 'SYNC_HP') {
                // ACTUALIZACI√ìN DE VIDA
                updateGlobalHP(data.hpState);
            }
        });
    }

    // --- 4. INICIO DE PARTIDA ---
    function processGameStart(localList, remoteList) {
        // Procesamos IDs √∫nicos para evitar choques (Host siempre es prefix 'H', Guest 'G')
        const prefixMe = (myRole === 'host') ? 'H-' : 'G-';
        const prefixOp = (myRole === 'host') ? 'G-' : 'H-';

        // 1. Procesar MIS unidades
        myUnits = localList.map(u => ({ ...u, uid: prefixMe + u.id }));
        
        // 2. Procesar unidades ENEMIGAS
        enemyUnits = remoteList.map(u => ({ ...u, uid: prefixOp + u.id }));

        // 3. Inicializar HP Global
        [...myUnits, ...enemyUnits].forEach(u => {
            globalHP[u.uid] = { curr: parseInt(u.stats.hp), max: parseInt(u.stats.hp) };
        });

        // 4. Arrancar UI
        setTimeout(() => {
            document.getElementById('wait-overlay').style.display = 'none';
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('hud-screen').classList.remove('hidden');
            
            // Iniciar c√°mara
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => document.getElementById('ar-feed').srcObject = s).catch(e=>{});

            document.getElementById('role-indicator').innerText = myRole === 'host' ? "HOST (J1)" : "GUEST (J2)";
            updateHUD();
        }, 1000);
    }

    // --- 5. GAMEPLAY ---
    function nextMyUnit() { myIdx = (myIdx + 1) % myUnits.length; updateHUD(); }
    function nextEnemyUnit() { enemyIdx = (enemyIdx + 1) % enemyUnits.length; updateHUD(); }

    function updateHUD() {
        const me = myUnits[myIdx];
        const enemy = enemyUnits[enemyIdx];

        // Render MY card
        const meHP = globalHP[me.uid];
        document.getElementById('my-name').innerText = me.name;
        document.getElementById('my-stats').innerText = `üî´ ${me.stats.r_atk} / ${me.stats.r_hit}`;
        document.getElementById('my-hp').style.width = (meHP.curr / meHP.max * 100) + "%";

        // Render ENEMY card
        const enHP = globalHP[enemy.uid];
        document.getElementById('enemy-name').innerText = enemy.name;
        document.getElementById('enemy-stats').innerText = `üõ°Ô∏è SV ${enemy.stats.sv}`;
        document.getElementById('enemy-hp').style.width = (enHP.curr / enHP.max * 100) + "%";
    }

    // --- 6. COMBATE ---
    function fireWeapon() {
        const atk = myUnits[myIdx];
        const def = enemyUnits[enemyIdx];
        const atkHP = globalHP[atk.uid];

        if(atkHP.curr <= 0) return log("‚ùå UNIDAD CA√çDA NO PUEDE DISPARAR");

        // Calcular dados localmente (Atacante tiene la autoridad)
        let dice = parseInt(atk.stats.r_atk);
        let hitVal = parseInt(atk.stats.r_hit.replace('+',''));
        let dmg = parseInt(atk.stats.r_dmg);

        let hits = 0;
        let rolls = [];
        for(let i=0; i<dice; i++) {
            let r = Math.ceil(Math.random()*6);
            rolls.push(r);
            if(r >= hitVal) hits++;
        }

        log(`YO: [${rolls.join(',')}] -> ${hits} IMPACTOS`);

        // Enviar datos al rival para que calcule su defensa
        // Le decimos: "Mi unidad X te peg√≥ Y veces con da√±o Z"
        conn.send({
            type: 'ATTACK',
            atkName: atk.name,
            defUid: def.uid, // ID √∫nico del objetivo
            hits: hits,
            dmg: dmg,
            svVal: parseInt(def.stats.sv) // Dato de referencia
        });
    }

    function resolveIncomingAttack(data) {
        // Soy el defensor. Recibo datos de ataque.
        const defUnit = myUnits.find(u => u.uid === data.defUid);
        
        // Si no encuentro la unidad (error raro), ignorar
        if(!defUnit) return;

        let saves = 0;
        let sRolls = [];
        // Tirar salvaciones autom√°ticamente
        for(let i=0; i<data.hits; i++) {
            let r = Math.ceil(Math.random()*6);
            sRolls.push(r);
            if(r >= parseInt(defUnit.stats.sv)) saves++;
        }

        let wounds = data.hits - saves;
        let totalDmg = wounds * data.dmg;

        log(`RIVAL dispara a ${defUnit.name}: ${wounds} entran (-${totalDmg} HP)`);

        // Aplicar da√±o
        if(totalDmg > 0) {
            globalHP[defUnit.uid].curr = Math.max(0, globalHP[defUnit.uid].curr - totalDmg);
            // ENVIAR NUEVO ESTADO DE VIDA A TODOS (Sync)
            conn.send({ type: 'SYNC_HP', hpState: globalHP });
            updateHUD();
            
            // Efecto visual
            document.body.style.backgroundColor = "#500";
            setTimeout(()=>document.body.style.backgroundColor="#000", 100);
        }
    }

    function updateGlobalHP(newState) {
        globalHP = newState;
        updateHUD();
    }

    function log(msg) {
        const c = document.getElementById('combat-log');
        c.innerHTML = `<div class="log-entry">> ${msg}</div>` + c.innerHTML;
    }
</script>
</body>
</html>
