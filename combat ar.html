<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUAD COMMAND: DEBUG MODE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --c: #00f2ff; --r: #ff0055; --bg: #0d1117; }
        body { margin: 0; background: #000; font-family: monospace; color: var(--c); overflow: hidden; }
        
        /* DIAGNOSTIC CONSOLE */
        #sys-log { 
            position: fixed; top: 0; left: 0; width: 100%; height: 150px; 
            background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--c);
            overflow-y: auto; font-size: 10px; padding: 5px; z-index: 999;
            pointer-events: none;
        }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid #222; }
        .log-err { color: var(--r); font-weight: bold; }
        .log-ok { color: #0f0; }

        /* UI */
        .screen { position: absolute; top: 150px; width: 100%; height: calc(100% - 150px); padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }
        
        input, textarea { background: #111; color: white; border: 1px solid #555; width: 100%; padding: 10px; margin-bottom: 10px; }
        button { background: var(--c); color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        
        .card { border: 1px solid #333; padding: 10px; margin-bottom: 10px; width: 100%; }
        .my-unit { border-left: 4px solid var(--c); }
        .enemy-unit { border-left: 4px solid var(--r); }
    </style>
</head>
<body>

    <div id="sys-log"><div>SISTEMA INICIADO...</div></div>

    <div id="lobby" class="screen">
        <h3>CONFIGURACI√ìN DE RED</h3>
        <textarea id="json-input" placeholder="PEGA JSON AQU√ç" style="height:50px;"></textarea>
        
        <div style="width:100%; border:1px solid #333; padding:10px; margin-bottom:20px;">
            <p style="margin:0 0 5px 0; font-size:0.8rem; color:#888;">TU IDENTIFICADOR DE RED:</p>
            <div id="my-peer-id" style="font-size:1.5rem; color:var(--r); font-weight:bold;">OBTENIENDO ID...</div>
        </div>

        <input type="text" id="remote-id" placeholder="ID DEL RIVAL (EJ: SQ-4821)">
        <button onclick="connectToPeer()">CONECTAR CON RIVAL</button>
        <button onclick="location.reload()" style="background:#333; color:#fff">REINICIAR</button>
    </div>

    <div id="game" class="screen hidden">
        <h3>EN COMBATE</h3>
        <div id="game-status" style="color:var(--r)">ESPERANDO DATOS...</div>
        <div id="battle-area" style="width:100%"></div>
        <button onclick="fireTest()">DISPARAR (TEST)</button>
    </div>

<script>
    // --- LOGGER VISUAL ---
    function log(msg, type='') {
        const d = new Date();
        const time = `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
        const el = document.getElementById('sys-log');
        const colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-ok' : '');
        el.innerHTML = `<div class="log-line ${colorClass}">[${time}] ${msg}</div>` + el.innerHTML;
    }

    // --- VARIABLES ---
    let peer = null;
    let conn = null;
    let mySquad = null;

    // --- 1. INICIAR PEER (AUTOM√ÅTICO) ---
    // Generamos una ID aleatoria corta
    const myId = "SQ-" + Math.floor(Math.random() * 9000 + 1000);
    
    log("Iniciando PeerJS con ID: " + myId);

    try {
        peer = new Peer(myId, {
            debug: 2
        });

        peer.on('open', (id) => {
            log("‚úÖ CONECTADO AL SERVIDOR PEERJS", 'success');
            log("TU ID ES: " + id, 'success');
            document.getElementById('my-peer-id').innerText = id;
        });

        peer.on('connection', (c) => {
            log("üîî ¬°ALGUIEN SE EST√Å CONECTANDO A TI!", 'success');
            conn = c;
            setupConnection();
        });

        peer.on('error', (err) => {
            log("‚ùå ERROR CR√çTICO: " + err.type, 'error');
            log("Detalle: " + err.message);
            if(err.type === 'peer-unavailable') log("El ID del rival no existe o no est√° conectado.");
            if(err.type === 'network') log("Problema de internet / Firewall.");
        });

        peer.on('disconnected', () => {
            log("‚ö†Ô∏è Desconectado del servidor de se√±alizaci√≥n.");
            peer.reconnect();
        });

    } catch (e) {
        log("‚ùå ERROR AL CREAR PEER: " + e.message, 'error');
    }

    // --- 2. CONECTAR MANUALMENTE ---
    function connectToPeer() {
        const target = document.getElementById('remote-id').value.trim();
        const json = document.getElementById('json-input').value;
        
        if(!json) return log("‚ö†Ô∏è PEGA EL JSON PRIMERO", 'error');
        if(!target) return log("‚ö†Ô∏è ESCRIBE LA ID DEL RIVAL", 'error');
        
        try {
            mySquad = JSON.parse(json);
        } catch(e) { return log("JSON INV√ÅLIDO", 'error'); }

        log("Intentando conectar con: " + target + "...");
        conn = peer.connect(target);
        setupConnection();
    }

    // --- 3. CONFIGURAR CONEXI√ìN ---
    function setupConnection() {
        conn.on('open', () => {
            log("ü§ù ¬°CANAL P2P ABIERTO!", 'success');
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('game-status').innerText = "CONECTADO";
            
            // Enviar saludo de prueba
            conn.send({ type: 'TEST', msg: 'Hola desde el otro lado' });
        });

        conn.on('data', (data) => {
            log("üì® DATO RECIBIDO: " + data.type);
            if(data.type === 'TEST') {
                alert("¬°SINCRONIZACI√ìN EXITOSA! Mensaje: " + data.msg);
            }
            if(data.type === 'FIRE') {
                log(`üî• DISPARO RECIBIDO: ${data.dmg} DA√ëO`, 'error');
                document.body.style.background = '#300';
                setTimeout(()=> document.body.style.background = '#000', 200);
            }
        });

        conn.on('close', () => {
            log("‚ùå CONEXI√ìN CERRADA POR EL RIVAL", 'error');
            alert("Rival desconectado");
            location.reload();
        });
    }

    function fireTest() {
        if(conn && conn.open) {
            log("Enviando disparo de prueba...");
            conn.send({ type: 'FIRE', dmg: 10 });
        } else {
            log("‚ùå NO HAY CONEXI√ìN ACTIVA", 'error');
        }
    }

</script>
</body>
</html>
