<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUAD COMMAND: v48 GEAR MECHANICS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root { --c: #00f2ff; --r: #ff0055; --g: #00ff99; --gold: #ffcc00; --bg: #0d1117; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: var(--c); user-select: none; -webkit-user-select: none; }

        #ar-feed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: contrast(1.2) brightness(0.6); }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: rgba(0, 242, 255, 0.3); animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; opacity:0; } 100% { top: 100%; opacity:0; } }

        .screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: var(--bg); z-index: 10; transition: 0.3s; align-items: center; }
        .screen.hidden { display: none !important; }
        .screen.transparent { background: transparent; pointer-events: none; padding: 0; }

        .box { border: 1px solid var(--c); padding: 15px; width: 100%; max-width: 400px; background: rgba(0,0,0,0.95); margin-bottom: 15px; text-align: center; }
        textarea { width: 100%; height: 60px; background: #111; color: #aaa; border: 1px solid #333; font-size: 0.7rem; font-family: monospace; }
        input, select { background: #000; border: 2px solid var(--gold); color: var(--gold); padding: 10px; font-family: monospace; width: 100%; text-align: center; font-size: 1rem; letter-spacing: 2px; margin: 5px 0; text-transform: uppercase; }
        
        .btn { 
            background: var(--c); color: #000; border: none; padding: 15px; width: 100%; 
            font-weight: bold; cursor: pointer; font-size: 1rem; 
            clip-path: polygon(5% 0, 100% 0, 100% 100%, 0 100%, 0 30%); 
            margin-top: 5px; pointer-events: auto; touch-action: manipulation;
        }
        .btn-small { font-size: 0.7rem; padding: 5px; width: auto; display: inline-block; clip-path: none; border: 1px solid var(--gold); background: #000; color: var(--gold); cursor: pointer; pointer-events: auto; }

        .ops-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; width: 100%; display: none; }
        .btn-op { font-size: 0.8rem; padding: 15px 5px; clip-path: none; border: 1px solid #000; color: #000; font-weight: bold; }
        
        /* Botones de Gear Especial */
        .btn-gear { background: #fff; color: #000; border: 2px solid var(--gold); font-size: 0.8rem; animation: pulseGold 2s infinite; }
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 var(--gold); } 50% { box-shadow: 0 0 10px var(--gold); } 100% { box-shadow: 0 0 0 var(--gold); } }

        .hud-top { position: absolute; top: 0; width: 100%; padding: 10px; display: flex; flex-direction: column; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); pointer-events: auto; width: 100%; box-sizing: border-box;}
        .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px; }
        
        .hud-bottom { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto; }
        .unit-selector { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        
        .card { width: 48%; border: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.85); cursor: pointer; min-height: 120px; transition: 0.2s; position: relative; display: flex; flex-direction: column; justify-content: space-between; pointer-events: auto !important; }
        .card.active { border-color: #fff; transform: scale(1.02); z-index: 5; }
        .card.my { border-left: 4px solid var(--c); }
        .card.enemy { border-left: 4px solid var(--r); }
        
        /* Etiquetas de Habilidades/Equipo */
        .tags-container { display:flex; flex-wrap:wrap; gap:2px; margin-top:4px; }
        .tag { font-size: 0.55rem; padding: 2px 4px; border-radius: 2px; text-transform: uppercase; font-weight: bold; }
        .tag.passive { background: #222; color: #aaa; border: 1px solid #444; }
        .tag.active { background: var(--gold); color: #000; border: 1px solid #fff; }
        .tag.used { text-decoration: line-through; opacity: 0.5; background: #000; color: #555; border-color: #333; }

        .hp-bar { height: 4px; background: #333; margin-top: 5px; width: 100%; }
        .hp-fill { height: 100%; transition: width 0.3s; }
        
        #dice-overlay { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; 
            background: rgba(0, 15, 30, 0.95); border-top: 4px solid var(--gold); 
            z-index: 100; display: flex; flex-direction: column; align-items: center; 
            transform: translateY(100%); transition: transform 0.3s; pointer-events: auto; padding-top: 20px;
        }
        #dice-overlay.show { transform: translateY(0); }
        .dice-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .die { font-size: 3.5rem; color: #fff; }
        
        .log-area { position: absolute; top: 80px; left: 10px; width: 70%; pointer-events: none; z-index: 50; }
        .log-entry { background: rgba(0,0,0,0.8); border-left: 3px solid var(--c); color: #fff; font-size: 0.7rem; padding: 5px; margin-bottom: 5px; text-shadow: 0 0 2px var(--c); }
    </style>
</head>
<body>

    <video id="ar-feed" autoplay playsinline muted></video>
    <div class="scan-line"></div>

    <div id="lobby-screen" class="screen">
        <h2 style="margin:0; color:var(--c)">SQUAD COMMAND</h2>
        <div style="font-size:0.7rem; color:var(--gold); margin-bottom:15px;">v48 ACTIVE GEAR</div>
        <div class="box"><textarea id="json-input" placeholder='{"squad": [{"name":"Trooper", "gear":"grenade", "ability":"regen", "stats":{...}}]}'></textarea></div>
        <div class="box" style="border-color:var(--gold);">
            <input type="text" id="room-id" value="WARZONE-1">
            <button type="button" class="btn" onclick="initSystem()"><span>DESPLEGAR</span></button>
        </div>
    </div>

    <div id="game-screen" class="screen transparent hidden">
        <div class="hud-top">
            <div class="top-row">
                <div style="font-weight:bold; color:#fff;">YO: <span id="my-score">0</span></div>
                <div id="turn-indicator" style="background:#000; padding:5px; border:1px solid #555; font-size:0.8rem;">ESPERANDO...</div>
                <div style="font-weight:bold; color:var(--r);">RIV: <span id="enemy-score">0</span></div>
            </div>
        </div>
        
        <div class="log-area" id="combat-log"></div>

        <div class="hud-bottom">
            <div id="planning-controls" style="text-align:center; margin-bottom:10px;">
                <button type="button" class="btn" id="btn-ready" onclick="commitPlanning()"><span>CONFIRMAR INICIATIVA</span></button>
            </div>

            <div class="unit-selector">
                <div class="card my" onclick="nextMyUnit()" id="my-card">
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:0.6rem;"><span>OPERATIVO</span></div>
                        <div id="my-name" style="font-weight:bold; font-size:1.1rem;">---</div>
                        <div class="tags-container" id="my-tags"></div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; margin-top:5px; font-size:0.7rem;">
                            <div>RNG: <span id="my-r" style="color:#fff">--</span></div>
                            <div>MEL: <span id="my-m" style="color:#fff">--</span></div>
                            <div>SV: <span id="my-sv" style="color:#fff">--</span></div>
                        </div>
                    </div>
                    <div class="hp-bar"><div id="my-hp" class="hp-fill" style="background:var(--c)"></div></div>
                </div>
                
                <div class="card enemy" onclick="nextEnemyUnit()" id="en-card">
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--r)"><span>OBJETIVO</span></div>
                        <div id="enemy-name" style="font-weight:bold; font-size:1.1rem;">---</div>
                        <div class="tags-container" id="en-tags"></div>
                    </div>
                    <div class="hp-bar"><div id="enemy-hp" class="hp-fill" style="background:var(--r)"></div></div>
                </div>
            </div>

            <div id="combat-actions" style="display:flex; gap:5px; flex-wrap:wrap;">
                <button type="button" class="btn" id="btn-shoot" style="flex:2; background:var(--r); color:#fff;" onclick="useAction('ATTACK')"><span>DISPARAR</span></button>
                <button type="button" class="btn btn-gear" id="btn-special" style="flex:2; display:none;" onclick="useSpecialGear()"><span>USAR ITEM</span></button>
                
                <button type="button" class="btn" style="flex:1; background:#555; color:#fff;" onclick="passTurn(0)"><span>PASAR</span></button>
            </div>
        </div>
    </div>

    <div id="dice-overlay">
        <div style="color:var(--gold); font-size:1.5rem; margin-bottom:20px;" id="dice-title">RESULTADO</div>
        <div class="dice-container" id="dice-pool"></div>
        <button type="button" class="btn" style="margin-top:20px; width:80%;" onclick="closeDice()">CERRAR</button>
    </div>

<script>
    // --- DICCIONARIO DE MEC√ÅNICAS ---
    // define el nombre visual, icono, y si activa un bot√≥n especial
    const MECHANICS_DB = {
        // --- ACTIVOS (Generan Bot√≥n) ---
        "granada": { name: "Granada", icon: "üí£", type: "ACTIVE", oneUse: true, func: "THROW_GRENADE", desc: "3 Dados, Impacta 3+" },
        "grenade": { name: "Granada", icon: "üí£", type: "ACTIVE", oneUse: true, func: "THROW_GRENADE", desc: "3 Dados, Impacta 3+" },
        "medkit":  { name: "Botiqu√≠n", icon: "üíä", type: "ACTIVE", oneUse: true, func: "USE_MEDKIT", desc: "Cura 3 HP" },
        "stim":    { name: "Estim",    icon: "üíâ", type: "ACTIVE", oneUse: true, func: "USE_STIM", desc: "Sufre 1 herida, gana +1 dado" },

        // --- PASIVOS / AUTO (Texto o l√≥gica interna) ---
        "regen":   { name: "Regen",    icon: "ü©∏", type: "AUTO", func: "AUTO_REGEN" }, // Se activa al inicio del turno
        "scope":   { name: "Mira",     icon: "üéØ", type: "PASSIVE" },
        "armor":   { name: "Placas",   icon: "üõ°Ô∏è", type: "PASSIVE" },
        "shield":  { name: "Escudo",   icon: "üîµ", type: "PASSIVE" },
        "stealth": { name: "Sigilo",   icon: "üëª", type: "PASSIVE" },
        "jetpack": { name: "Propulsor",icon: "üöÄ", type: "PASSIVE" }
    };

    const BROKER = "broker.hivemq.com"; const PORT = 8884;
    let MY_ID = "OP_" + Math.random().toString(16).substr(2, 6);
    let client=null, TOPIC="";
    let myUnits=[], enemyUnits=[], globalHP={};
    let myIdx=0, enIdx=0;
    let gameState = 'PLANNING';
    let myVP=0, enemyVP=0;

    // --- INIT ---
    function initSystem() {
        const json = document.getElementById('json-input').value;
        const code = document.getElementById('room-id').value.trim().toUpperCase();
        
        try {
            const parsed = JSON.parse(json);
            // PROCESAR UNIDADES (SIN TOCAR STATS, SOLO AGREGAR METADATA)
            myUnits = parsed.squad.map(u => {
                let unit = { 
                    ...u, 
                    uid: `${MY_ID}_${u.id || Math.random()}`, 
                    acted: false,
                    specialUsed: false // Para trackear items de un uso
                };
                // Detectar Gear/Ability y buscar en DB
                unit.mechanics = [];
                if(u.gear) mapMechanic(unit, u.gear);
                if(u.ability) mapMechanic(unit, u.ability);
                return unit;
            });

            // Inicializar HP Global
            myUnits.forEach(u => { globalHP[u.uid] = {c:parseInt(u.stats.hp), m:parseInt(u.stats.hp)}; });

            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>document.getElementById('ar-feed').srcObject=s).catch(e=>{});
            
            updateHUD();
            startNetwork(code);
        } catch(e) { alert("JSON ERROR: " + e.message); }
    }

    function mapMechanic(unit, key) {
        const k = key.toLowerCase();
        if(MECHANICS_DB[k]) {
            unit.mechanics.push({ id: k, ...MECHANICS_DB[k] });
        } else {
            // Fallback gen√©rico para cosas no en DB
            unit.mechanics.push({ id: k, name: key, icon: "üîπ", type: "PASSIVE" });
        }
    }

    // --- NETWORK ---
    function startNetwork(code) {
        TOPIC = `sqcmd/v48/${code}`;
        client = new Paho.MQTT.Client(BROKER, PORT, MY_ID);
        client.onMessageArrived = onMessage;
        client.connect({useSSL:true, onSuccess:()=>{ 
            client.subscribe(TOPIC);
            publish({type:'JOIN', squad: myUnits});
        }});
    }

    function onMessage(msg) {
        const d = JSON.parse(msg.payloadString);
        if(d.sender === MY_ID) return;
        
        if(d.type === 'JOIN') {
            if(!enemyUnits.length) {
                enemyUnits = d.squad;
                enemyUnits.forEach(u => { if(!globalHP[u.uid]) globalHP[u.uid] = {c:parseInt(u.stats.hp), m:parseInt(u.stats.hp)}; });
                publish({type:'SYNC_HP', hp: globalHP}); // Mandar mi HP al nuevo
                updateHUD();
                log("RIVAL CONECTADO");
            }
        }
        else if(d.type === 'SYNC_HP') { globalHP = {...globalHP, ...d.hp}; updateHUD(); }
        else if(d.type === 'ATTACK') {
            log(`RIVAL ATACA: ${d.hits} IMPACTOS (Da√±o ${d.dmg})`);
            // Aplicar da√±o simple (sin tirada de salvaci√≥n interactiva para simplificar demo)
            const target = myUnits.find(u => u.uid === d.targetUid);
            if(target) {
                applyDamage(target.uid, d.finalDmg); 
                alert(`¬°TE HAN DISPARADO!\nUnidad: ${target.name}\nDa√±o: ${d.finalDmg}`);
            }
        }
        else if(d.type === 'GRENADE') {
            log(`¬°GRANADA ENEMIGA! ${d.hits} Impactos`);
            // Efecto de √°rea simple: da√±a a la unidad seleccionada
            const target = myUnits[myIdx]; 
            if(target) { applyDamage(target.uid, d.hits); alert("¬°BOOM! GRANADA RECIBIDA"); }
        }
        else if(d.type === 'TURN_CHANGE') {
            gameState = 'MY_TURN';
            document.getElementById('turn-indicator').innerText = "TU TURNO";
            document.getElementById('turn-indicator').style.background = "var(--c)";
            document.getElementById('turn-indicator').style.color = "#000";
            document.getElementById('combat-actions').style.display = 'flex';
            checkAutoMechanics(); // Chequear regeneraci√≥n
        }
    }

    function publish(payload) { if(client) { payload.sender = MY_ID; client.send(TOPIC, JSON.stringify(payload)); } }

    // --- GAMEPLAY MECHANICS ---

    function commitPlanning() {
        // Simple switch a combate
        document.getElementById('planning-controls').style.display = 'none';
        gameState = 'MY_TURN'; // Simplificado: empiezas t√∫ para probar
        document.getElementById('turn-indicator').innerText = "TU TURNO";
        document.getElementById('turn-indicator').style.background = "var(--c)";
        document.getElementById('turn-indicator').style.color = "#000";
        checkAutoMechanics();
    }

    function checkAutoMechanics() {
        // L√≥gica para "Regen" al inicio del turno
        const me = myUnits[myIdx];
        const regen = me.mechanics.find(m => m.func === 'AUTO_REGEN');
        if(regen && globalHP[me.uid].c < globalHP[me.uid].m && globalHP[me.uid].c > 0) {
            globalHP[me.uid].c++;
            log(`AUTO: ${me.name} REGENERA 1 HP`);
            publish({type: 'SYNC_HP', hp: globalHP});
            updateHUD();
        }
    }

    window.useAction = function(type) {
        if(gameState !== 'MY_TURN') return;
        const me = myUnits[myIdx];
        
        if(type === 'ATTACK') {
            // L√≥gica normal de disparo
            const dice = parseInt(me.stats.r_atk);
            const hit = parseInt(me.stats.r_hit.replace('+',''));
            const dmg = parseInt(me.stats.r_dmg);
            
            const results = rollDice(dice);
            const hits = results.filter(r => r >= hit).length;
            const totalDmg = hits * dmg;

            showDiceResult(results, hit);
            log(`DISPARO: ${hits} hits. Da√±o Potencial: ${totalDmg}`);

            if(enemyUnits.length > 0) {
                publish({type:'ATTACK', targetUid: enemyUnits[enIdx].uid, hits: hits, dmg: dmg, finalDmg: totalDmg});
            }
            passTurn(0);
        }
    }

    window.useSpecialGear = function() {
        if(gameState !== 'MY_TURN') return;
        const me = myUnits[myIdx];
        // Buscar el item activo
        const activeItem = me.mechanics.find(m => m.type === 'ACTIVE' && !me.specialUsed);
        
        if(!activeItem) return;

        if(activeItem.func === 'THROW_GRENADE') {
            // Mec√°nica de Granada
            const results = rollDice(3); // 3 Dados fijos
            const hits = results.filter(r => r >= 3).length; // Impacta a 3+
            showDiceResult(results, 3);
            log(`LANZA GRANADA: ${hits} Impactos!`);
            publish({type:'GRENADE', hits: hits});
            
        } else if (activeItem.func === 'USE_MEDKIT') {
            // Mec√°nica de Botiqu√≠n
            const heal = 3;
            globalHP[me.uid].c = Math.min(globalHP[me.uid].m, globalHP[me.uid].c + heal);
            log(`MEDKIT: ${me.name} recupera ${heal} HP`);
            publish({type:'SYNC_HP', hp: globalHP});
            updateHUD();
            // No termina turno, es una acci√≥n gratis? O termina? Asumamos que termina.
        } else if (activeItem.func === 'USE_STIM') {
            // Estimulante: -1 HP, Buff temporal (simulado)
            globalHP[me.uid].c = Math.max(0, globalHP[me.uid].c - 1);
            log(`ESTIMULANTE: Sufres 1 da√±o, +1 Dado (Narrativo)`);
            publish({type:'SYNC_HP', hp: globalHP});
            updateHUD();
        }

        // Marcar como usado si es OneUse
        if(activeItem.oneUse) {
            me.specialUsed = true;
            updateHUD(); // Para ocultar el bot√≥n
        }
        passTurn(0);
    }

    window.passTurn = function(p) {
        gameState = 'ENEMY_TURN';
        document.getElementById('turn-indicator').innerText = "TURNO RIVAL";
        document.getElementById('turn-indicator').style.background = "#333";
        document.getElementById('turn-indicator').style.color = "#888";
        document.getElementById('combat-actions').style.display = 'none';
        publish({type:'TURN_CHANGE'});
    }

    function applyDamage(uid, dmg) {
        if(globalHP[uid]) {
            globalHP[uid].c = Math.max(0, globalHP[uid].c - dmg);
            publish({type:'SYNC_HP', hp: globalHP});
            updateHUD();
        }
    }

    // --- UI HELPERS ---
    window.nextMyUnit = function() { myIdx = (myIdx+1)%myUnits.length; updateHUD(); checkAutoMechanics(); }
    window.nextEnemyUnit = function() { if(enemyUnits.length) enIdx = (enIdx+1)%enemyUnits.length; updateHUD(); }

    function updateHUD() {
        if(!myUnits.length) return;
        const me = myUnits[myIdx];
        const en = enemyUnits[enIdx];

        // 1. Render Stats B√°sicas (directo del JSON)
        document.getElementById('my-name').innerText = me.name;
        document.getElementById('my-r').innerText = `${me.stats.r_atk}d (${me.stats.r_hit})`;
        document.getElementById('my-m').innerText = `${me.stats.m_atk}d (${me.stats.m_hit})`;
        document.getElementById('my-sv').innerText = me.stats.sv;
        document.getElementById('my-hp').style.width = (globalHP[me.uid].c / globalHP[me.uid].m * 100) + "%";

        // 2. Render TAGS (Habilidades Visuales)
        const tagContainer = document.getElementById('my-tags');
        tagContainer.innerHTML = '';
        let hasActiveAvailable = false;
        let activeActionName = "";

        me.mechanics.forEach(m => {
            const span = document.createElement('span');
            span.className = `tag ${m.type === 'ACTIVE' ? 'active' : 'passive'}`;
            // Si es item usado, tacharlo
            if(m.type === 'ACTIVE' && me.specialUsed && m.oneUse) {
                span.classList.add('used');
            }
            span.innerHTML = `${m.icon} ${m.name}`;
            tagContainer.appendChild(span);

            // Chequear si mostramos bot√≥n especial
            if(m.type === 'ACTIVE' && (!m.oneUse || !me.specialUsed)) {
                hasActiveAvailable = true;
                activeActionName = m.func === 'THROW_GRENADE' ? "LANZAR GRANADA" : 
                                   m.func === 'USE_MEDKIT' ? "USAR MEDKIT" : "USAR ITEM";
            }
        });

        // 3. Bot√≥n Din√°mico
        const btnSpecial = document.getElementById('btn-special');
        if(gameState === 'MY_TURN' && hasActiveAvailable) {
            btnSpecial.style.display = 'block';
            btnSpecial.querySelector('span').innerText = activeActionName;
        } else {
            btnSpecial.style.display = 'none';
        }

        // Render Enemy
        if(en) {
            document.getElementById('enemy-name').innerText = en.name;
            document.getElementById('enemy-hp').style.width = (globalHP[en.uid].c / globalHP[en.uid].m * 100) + "%";
            // Render Enemy Tags (simple)
            const enTags = document.getElementById('en-tags');
            enTags.innerHTML = '';
            if(en.gear) enTags.innerHTML += `<span class="tag passive">‚öô ${en.gear}</span>`;
            if(en.ability) enTags.innerHTML += `<span class="tag passive">‚òÖ ${en.ability}</span>`;
        }
    }

    function rollDice(n) { return Array(n).fill(0).map(()=>Math.ceil(Math.random()*6)); }
    function showDiceResult(dice, target) {
        const pool = document.getElementById('dice-pool');
        pool.innerHTML = '';
        dice.forEach(d => {
            const el = document.createElement('div'); el.className = 'die';
            el.innerText = ['?','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][d];
            el.style.color = d >= target ? 'var(--g)' : '#555';
            pool.appendChild(el);
        });
        document.getElementById('dice-overlay').classList.add('show');
    }
    window.closeDice = () => document.getElementById('dice-overlay').classList.remove('show');
    function log(msg) { document.getElementById('combat-log').innerHTML = `<div class="log-entry">${msg}</div>` + document.getElementById('combat-log').innerHTML; }

</script>
</body>
</html>
