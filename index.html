<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Post-its Digitales (corrigido)</title>
<style>
  :root{
    --bg:#f0f0f0;
  }
  body{
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    margin:0;
    padding:12px;
  }

  button#newNoteBtn{
    padding:8px 12px;
    background:#3182ce;color:#fff;border:none;border-radius:6px;cursor:pointer;
    margin-bottom:8px;
  }

  /* tablero ocupa el resto */
  #board{
    position:relative;
    width:100%;
    height:calc(100vh - 64px);
    overflow:auto;
    background: linear-gradient(180deg,#f9fafb,#eef2f6);
    border-radius:8px;
    padding:10px;
  }

  /* nota base */
  .note{
    position:absolute;
    width:220px;
    min-height:150px;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    resize:both;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    user-select:none;
  }

  .note .note-header{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 8px;
    background:rgba(0,0,0,0.06);
    cursor:grab;
  }
  .drag-handle{
    width:20px;
    height:20px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    cursor:grab;
  }
  .note .title{
    flex:1;
    font-weight:700;
    font-size:14px;
    outline:none;
  }
  .note .btns{
    display:flex;
    gap:6px;
  }
  .small-btn{
    width:26px;height:26px;border-radius:4px;border:none;cursor:pointer;
  }
  .small-btn.del{background:#e53e3e;color:#fff}
  .small-btn.menu{background:#718096;color:#fff}

  .note .note-body{
    padding:8px;
    background:transparent;
    flex:1;
    overflow:auto;
    outline:none;
  }

  /* tipos / colores */
  .tipo-nota{ background:#fff9a6; }
  .tipo-recordatorio{ background:#c6f6d5; }
  .tipo-mensaje{ background:#bee3f8; }
  .tipo-importante{ background:#feb2b2; }
  .tipo-lista{ background:#ffffff; border:1px solid #e2e8f0; }

  .tipo-nota .title{ color:#8a6d3b; }
  .tipo-recordatorio .title{ color:#276749; }
  .tipo-mensaje .title{ color:#2b6cb0; }
  .tipo-importante .title{ color:#c53030; }
  .tipo-lista .title{ color:#2d3748; }

  /* men√∫ contextual simple */
  #contextMenu{
    position: absolute;
    display:none;
    background:#fff;
    border:1px solid #cbd5e0;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    border-radius:6px;
    z-index:99999;
  }
  #contextMenu ul{ list-style:none;margin:0;padding:6px 0; }
  #contextMenu li{ padding:8px 14px; cursor:pointer; white-space:nowrap; }
  #contextMenu li:hover{ background:#f1f5f9; }

  /* hint para dispositivos t√°ctiles (opcional) */
  @media (max-width:600px){
    #board{ height:calc(100vh - 120px); }
  }

</style>
</head>
<body>

<button id="newNoteBtn">‚ûï Nueva nota</button>
<div id="board" tabindex="0"></div>

<!-- men√∫ contextual -->
<div id="contextMenu">
  <ul>
    <li data-type="nota">üìù Nota</li>
    <li data-type="recordatorio">‚è∞ Recordatorio</li>
    <li data-type="mensaje">üí¨ Mensaje</li>
    <li data-type="importante">üî¥ Importante</li>
    <li data-type="lista">üìã Lista</li>
  </ul>
</div>

<script>
/* -------------------------
   UTIL: etiquetas por tipo
   ------------------------- */
const TYPE_LABEL = {
  'nota':       { class: 'tipo-nota', label: 'Nota' },
  'recordatorio': { class: 'tipo-recordatorio', label: 'Recordatorio' },
  'mensaje':    { class: 'tipo-mensaje', label: 'Mensaje' },
  'importante': { class: 'tipo-importante', label: 'Importante' },
  'lista':      { class: 'tipo-lista', label: 'Lista' }
};

/* -------------------------
   Estado global y handlers
   ------------------------- */
const board = document.getElementById('board');
const newBtn = document.getElementById('newNoteBtn');
const ctxMenu = document.getElementById('contextMenu');

let zIndexCounter = 100;
let dragged = null;
let dragOffset = {x:0,y:0};
let currentContextNote = null;

/* Refs para ResizeObserver (para guardar tama√±o) */
const ro = ('ResizeObserver' in window) ? new ResizeObserver(entries => {
  for(const ent of entries){
    const n = ent.target;
    // guardar cambios (debounced?)
    saveNotes();
  }
}) : null;

/* Eventos globales para drag */
document.addEventListener('mousemove', function(e){
  if (!dragged) return;
  e.preventDefault();
  const nx = e.clientX - dragOffset.x;
  const ny = e.clientY - dragOffset.y;
  dragged.style.left = nx + 'px';
  dragged.style.top  = ny + 'px';
});

document.addEventListener('mouseup', function(e){
  if (dragged){
    dragged = null;
    // guardar posici√≥n final
    saveNotes();
  }
});

/* Cerrar men√∫ contextual en clic fuera */
document.addEventListener('click', (e)=>{
  if (ctxMenu.style.display === 'block' && !ctxMenu.contains(e.target)) {
    ctxMenu.style.display = 'none';
    currentContextNote = null;
  }
});

/* Manejo men√∫ contextual (click en opci√≥n) */
ctxMenu.addEventListener('click', function(e){
  const li = e.target.closest('li[data-type]');
  if(!li || !currentContextNote) return;
  const type = li.getAttribute('data-type');
  applyTypeToNote(currentContextNote, type);
  ctxMenu.style.display = 'none';
  currentContextNote = null;
  saveNotes();
});

/* -------------------------
   Crear / renderizar nota
   ------------------------- */
function createNoteElement(data = {}) {
  const note = document.createElement('div');
  const tipo = data.type || 'tipo-nota';
  note.className = `note ${tipo}`;
  note.style.left = data.left || (20 + Math.random()*80) + 'px';
  note.style.top  = data.top  || (20 + Math.random()*80) + 'px';
  note.style.width = data.width || '220px';
  note.style.height = data.height || '180px';
  note.style.zIndex = ++zIndexCounter;

  // header (drag handle + title + buttons)
  const header = document.createElement('div'); header.className = 'note-header';
  const handle = document.createElement('div'); handle.className = 'drag-handle'; handle.textContent = '‚â°';
  const title = document.createElement('div'); title.className = 'title'; title.contentEditable = 'true';
  title.innerText = data.title || TYPE_LABEL[tipoToKey(tipo)].label || 'T√≠tulo';
  const btns = document.createElement('div'); btns.className = 'btns';
  const del = document.createElement('button'); del.className = 'small-btn del'; del.title = 'Eliminar'; del.innerText = '‚úñ';
  const menu = document.createElement('button'); menu.className = 'small-btn menu'; menu.title = 'Tipo'; menu.innerText = '‚ãØ';

  btns.appendChild(menu); btns.appendChild(del);
  header.appendChild(handle); header.appendChild(title); header.appendChild(btns);

  // body
  const body = document.createElement('div'); body.className = 'note-body'; body.contentEditable = 'true';
  body.innerText = data.content || '';

  note.appendChild(header);
  note.appendChild(body);

  // eventos
  // drag start only from handle
  handle.addEventListener('mousedown', function(e){
    e.preventDefault();
    dragged = note;
    dragOffset.x = e.clientX - note.offsetLeft;
    dragOffset.y = e.clientY - note.offsetTop;
    note.style.zIndex = ++zIndexCounter;
  });

  // delete
  del.addEventListener('click', function(e){
    e.stopPropagation();
    note.remove();
    saveNotes();
  });

  // open context menu for type selection when clicking the menu btn
  menu.addEventListener('click', function(e){
    e.stopPropagation();
    currentContextNote = note;
    showContextMenuAt(e.pageX, e.pageY);
  });

  // right-click anywhere on body/title to open type menu
  note.addEventListener('contextmenu', function(e){
    e.preventDefault();
    currentContextNote = note;
    showContextMenuAt(e.pageX, e.pageY);
  });

  // focus title/body -> bring to front
  title.addEventListener('focus', ()=>{ note.style.zIndex = ++zIndexCounter; });
  body.addEventListener('focus', ()=>{ note.style.zIndex = ++zIndexCounter; });

  // save on input
  title.addEventListener('input', debounce(saveNotes, 300));
  body.addEventListener('input', debounce(saveNotes, 300));

  // save on mouseup after possible resize
  note.addEventListener('mouseup', function(){ saveNotes(); });

  // observe size changes
  if (ro) ro.observe(note);

  return note;
}

/* -------------------------
   Aux helpers
   ------------------------- */

function tipoToKey(tipoClass){
  // tipoClass is like 'tipo-nota' ; returns 'nota'
  if(!tipoClass) return 'nota';
  const m = tipoClass.match(/^tipo-(.+)$/);
  return m ? m[1] : 'nota';
}

function applyTypeToNote(note, typeKey){
  const mapping = TYPE_LABEL[typeKey];
  if(!mapping) return;
  // quitar classes tipo-*
  note.classList.forEach(c => {
    if (c.startsWith('tipo-')) note.classList.remove(c);
  });
  note.classList.add(mapping.class);

  // cambiar t√≠tulo si el usuario no lo personaliz√≥:
  const titleEl = note.querySelector('.title');
  const current = (titleEl && titleEl.innerText && titleEl.innerText.trim()) ? titleEl.innerText.trim() : '';
  const genericSet = new Set([
    'T√≠tulo','Nota','Recordatorio','Mensaje','Importante','Lista',''
  ]);
  if (genericSet.has(current)) {
    titleEl.innerText = mapping.label;
  }
}

function showContextMenuAt(x,y){
  ctxMenu.style.left = x + 'px';
  ctxMenu.style.top  = y + 'px';
  ctxMenu.style.display = 'block';
}

/* Debounce util */
function debounce(fn, wait){
  let t;
  return function(...a){
    clearTimeout(t);
    t = setTimeout(()=>fn.apply(this,a), wait);
  };
}

/* -------------------------
   Persistencia: guardar / cargar
   ------------------------- */

function saveNotes(){
  const arr = [];
  document.querySelectorAll('.note').forEach(note=>{
    const type = Array.from(note.classList).find(c => c.startsWith('tipo-')) || 'tipo-nota';
    arr.push({
      type: type,
      left: note.style.left || '0px',
      top: note.style.top || '0px',
      width: note.style.width || getComputedStyle(note).width,
      height: note.style.height || getComputedStyle(note).height,
      title: (note.querySelector('.title')?.innerText || '').trim(),
      content: (note.querySelector('.note-body')?.innerText || '').trim()
    });
  });
  try{
    localStorage.setItem('notes', JSON.stringify(arr));
  }catch(e){
    console.error('Error guardando notes en localStorage', e);
  }
}

function loadNotes(){
  const raw = localStorage.getItem('notes') || '[]';
  let arr = [];
  try { arr = JSON.parse(raw); } catch(e){ arr = []; }
  if (!Array.isArray(arr)) arr = [];
  arr.forEach(d => {
    const el = createNoteElement(d);
    // restore zIndex maybe not needed
    board.appendChild(el);
  });
}

/* -------------------------
   Crear nota nueva
   ------------------------- */
newBtn.addEventListener('click', ()=>{
  const el = createNoteElement({ type: 'tipo-nota', title:'Nota', content:'Escribe aqu√≠...' });
  board.appendChild(el);
  saveNotes();
});

/* -------------------------
   Inicializaci√≥n
   ------------------------- */
window.addEventListener('load', ()=>{
  loadNotes();
});

/* -------------------------
   Manejo teclado: ESC oculta men√∫
   ------------------------- */
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    ctxMenu.style.display = 'none';
    currentContextNote = null;
  }
});
</script>
</body>
</html>
