<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ArUco 4.8.0 Safe Mode</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: monospace; overflow: hidden; }
        
        #container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
        #view-area { position: relative; flex: 1; overflow: hidden; background: #222; }

        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0.01; pointer-events: none;
        }
        canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 10;
        }

        #controls {
            height: 140px; background: #111; color: #0f0;
            display: flex; flex-direction: column;
            padding: 5px; box-sizing: border-box; z-index: 20; border-top: 1px solid #444;
        }
        button {
            padding: 10px; font-size: 16px; font-weight: bold;
            background: #007bff; color: white; border: none; 
            border-radius: 4px; margin-bottom: 5px; cursor: pointer;
        }
        textarea#log {
            flex: 1; background: #000; color: #0f0; 
            border: 1px solid #555; padding: 5px;
            font-family: monospace; font-size: 11px; resize: none;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="view-area">
        <video id="videoInput" playsinline webkit-playsinline autoplay muted></video>
        <canvas id="canvasOutput"></canvas>
    </div>
    <div id="controls">
        <button id="btnStart" disabled>Cargando Motor 4.8...</button>
        <textarea id="log" readonly>Iniciando...</textarea>
    </div>
</div>

<script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onCvLoaded()"></script>

<script>
    const logArea = document.getElementById('log');
    function log(msg) {
        console.log(msg);
        let time = new Date().toLocaleTimeString();
        logArea.value = `[${time}] ${msg}\n` + logArea.value; 
    }

    let video = document.getElementById('videoInput');
    let canvas = document.getElementById('canvasOutput');
    let btnStart = document.getElementById('btnStart');
    
    let stream = null;
    let streaming = false;
    
    // Objetos OpenCV
    let cap = null;
    let src = null;
    let gray = null;
    
    // Objetos ArUco
    let detector = null;
    let markerIds = null;
    let markerCorners = null;
    let rejected = null;

    function onCvLoaded() {
        log("Librería cargada. Verificando módulos...");
        
        // Verificación rápida
        if (cv.aruco_ArucoDetector) {
            log("Módulo ArUco detectado correctamente.");
        } else {
            log("ALERTA: ArucoDetector no encontrado en 'cv'.");
        }

        btnStart.innerText = "INICIAR ARUCO";
        btnStart.disabled = false;
        btnStart.onclick = startCamera;
    }

    async function startCamera() {
        btnStart.disabled = true;
        log("Abriendo cámara...");

        try {
            const constraints = { 
                video: { facingMode: 'environment' }, 
                audio: false 
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            await video.play();
            log("Video corriendo. Midiendo...");
            
            checkVideoReady();

        } catch (err) {
            log("ERROR CAMARA: " + err.message);
            btnStart.disabled = false;
        }
    }

    function checkVideoReady() {
        if (video.videoWidth > 0 && video.videoHeight > 0) {
            log(`Resolución: ${video.videoWidth}x${video.videoHeight}`);
            startProcessing();
        } else {
            requestAnimationFrame(checkVideoReady);
        }
    }

    function startProcessing() {
        streaming = true;
        
        // Sincronizar dimensiones
        video.width = video.videoWidth;
        video.height = video.videoHeight;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Inicializar matrices base
        cap = new cv.VideoCapture(video);
        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat();
        
        // --- INICIALIZACIÓN SEGURA DE ARUCO ---
        try {
            log("Configurando detector...");

            // 1. Diccionario
            let dictionary = cv.getPredefinedDictionary(cv.DICT_ARUCO_ORIGINAL);
            
            // 2. Parámetros
            let params = new cv.aruco_DetectorParameters();

            // 3. Crear Detector (EL TRUCO: Constructor Vacío)
            // Esto evita el error "invalid number of parameters"
            detector = new cv.aruco_ArucoDetector(); 
            
            // 4. Asignar configuración manualmente
            detector.setDictionary(dictionary);
            detector.setDetectorParameters(params);
            
            log("Detector creado con éxito (Modo Seguro).");

        } catch (e) {
            log("ERROR CRITICO ARUCO: " + e);
            // Intento desesperado: Constructor con RefineParameters
            try {
               log("Intentando constructor completo...");
               let refine = new cv.aruco_RefineParameters(10, 3, true);
               let dict = cv.getPredefinedDictionary(cv.DICT_ARUCO_ORIGINAL);
               let par = new cv.aruco_DetectorParameters();
               detector = new cv.aruco_ArucoDetector(dict, par, refine);
               log("Detector recuperado con constructor completo.");
            } catch (e2) {
               log("FALLO TOTAL: " + e2);
               return;
            }
        }
        
        // Matrices de salida
        markerIds = new cv.Mat();
        markerCorners = new cv.MatVector();
        rejected = new cv.MatVector();

        log("Sistema ArUco Operativo.");
        requestAnimationFrame(processFrame);
    }

    function processFrame() {
        if (!streaming) return;

        try {
            // Protección contra cambio de tamaño (bad size error)
            if (video.videoWidth !== src.cols || video.videoHeight !== src.rows) {
                video.width = video.videoWidth;
                video.height = video.videoHeight;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                src.delete();
                gray.delete();
                src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                gray = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
            }

            // 1. Capturar
            cap.read(src);
            
            // 2. Procesar
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            
            // 3. Detectar
            detector.detectMarkers(gray, markerCorners, markerIds, rejected);

            // 4. Dibujar
            if (markerIds.rows > 0) {
                cv.drawDetectedMarkers(src, markerCorners, markerIds, new cv.Scalar(0, 255, 0, 255));
            }
            
            cv.imshow('canvasOutput', src);

            requestAnimationFrame(processFrame);

        } catch (err) {
            // Loguear solo 1 vez para no colgar el móvil
            if (!window.hasLoggedError) {
                log("LOOP ERROR: " + err);
                window.hasLoggedError = true;
            }
            requestAnimationFrame(processFrame);
        }
    }
</script>
</body>
</html>
