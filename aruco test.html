<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ArUco Multi-Diccionario</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; }
        
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        
        video { display: none; }
        canvas { position: absolute; top: 0; left: 0; max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* Panel de Control */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; /* Dejar pasar clicks al canvas si fuera necesario */
            display: flex; flex-direction: column; align-items: center;
        }

        #controls {
            margin-top: 15px;
            pointer-events: auto; /* Reactivar clicks para el selector */
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        select {
            font-size: 16px; padding: 8px; border-radius: 5px; border: none;
            background: #eee; color: #333; font-weight: bold;
        }

        #stats { margin-top: 5px; font-size: 12px; color: #0f0; text-shadow: 1px 1px 0 #000; }
        .loading { color: yellow; }
    </style>
</head>
<body>

<div id="container">
    <video id="videoInput" playsinline webkit-playsinline></video>
    <canvas id="canvasOutput"></canvas>
    
    <div id="ui-layer">
        <div id="controls">
            <label for="dictSelect">Diccionario:</label>
            <br>
            <select id="dictSelect" onchange="changeDictionary()">
                <option value="4x4">4x4 (Estándar)</option>
                <option value="5x5">5x5</option>
                <option value="ORIGINAL">ArUco Original</option>
            </select>
            <div id="stats" class="loading">Cargando OpenCV...</div>
        </div>
    </div>
</div>

<script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>

<script>
    let video = document.getElementById('videoInput');
    let canvas = document.getElementById('canvasOutput');
    let statsDiv = document.getElementById('stats');
    let selector = document.getElementById('dictSelect');

    let stream = null;
    let streaming = false;
    
    // Objetos OpenCV
    let cap = null;
    let src = null;
    let gray = null;
    let dictionary = null;
    let markerIds = null;
    let markerCorners = null;
    let params = null;

    // Mapa de constantes de diccionarios
    // Se llenará cuando OpenCV cargue
    let dictMap = {};

    function onOpenCvReady() {
        statsDiv.innerText = 'OpenCV Listo. Iniciando cámara...';
        
        // Mapeamos los valores del selector a las constantes de OpenCV
        dictMap = {
            "4x4": cv.DICT_4X4_250,      // Cubre hasta 250 IDs (común)
            "5x5": cv.DICT_5X5_250,      // Cubre hasta 250 IDs
            "ORIGINAL": cv.DICT_ARUCO_ORIGINAL // Diccionario antiguo estándar
        };

        startCamera();
    }

    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.play();
            video.onloadedmetadata = function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                startProcessing();
            };
        } catch (err) {
            statsDiv.innerText = 'Error Cámara: ' + err.name;
            statsDiv.style.color = 'red';
        }
    }

    function startProcessing() {
        if (streaming) return;
        streaming = true;

        cap = new cv.VideoCapture(video);
        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat();
        
        // Configuración inicial del diccionario (basado en el selector)
        let initialDict = selector.value;
        dictionary = new cv.aruco_Dictionary(dictMap[initialDict]);
        
        params = new cv.aruco_DetectorParameters();
        markerIds = new cv.Mat();
        markerCorners = new cv.MatVector();

        requestAnimationFrame(processVideo);
    }

    // Función para cambiar el diccionario dinámicamente
    function changeDictionary() {
        if (!dictionary) return;

        let selectedValue = selector.value;
        let cvConstant = dictMap[selectedValue];

        // IMPORTANTE: En C++/WASM hay que borrar la memoria del objeto anterior
        dictionary.delete();
        
        // Crear el nuevo diccionario
        dictionary = new cv.aruco_Dictionary(cvConstant);
        
        console.log(`Diccionario cambiado a: ${selectedValue}`);
        statsDiv.innerText = `Cambiado a ${selectedValue}`;
    }

    function processVideo() {
        try {
            if (!streaming) return;

            cap.read(src);
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Detección
            cv.detectMarkers(gray, dictionary, markerCorners, markerIds, params);

            // Dibujar
            cv.imshow('canvasOutput', src);

            if (markerIds.rows > 0) {
                // Dibujar marcadores detectados
                cv.drawDetectedMarkers(src, markerCorners, markerIds, new cv.Scalar(0, 255, 0, 255));
                cv.imshow('canvasOutput', src); // Actualizar con dibujo
                
                statsDiv.innerText = `Detectados: ${markerIds.rows} (Tipo: ${selector.value})`;
            } else {
                statsDiv.innerText = `Buscando marcadores ${selector.value}...`;
            }

            requestAnimationFrame(processVideo);
        } catch (err) {
            console.error(err);
        }
    }
</script>
</body>
</html>